<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopkeeper Adventure UI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {# Removed <style> block - content moved to style.css #}
</head>
<body>
    {% if not user_logged_in %}
    <main class="login-container centered-content">
        <h2>Login</h2>
        <form action="{{ url_for('login_route') }}" method="post">
            <div>
                <label for="login_username">Username:</label>
                <input type="text" id="login_username" name="username" placeholder="Username" required>
            </div>
            <div>
                <label for="login_password">Password:</label>
                <input type="password" id="login_password" name="password" placeholder="Password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="{{ url_for('register_page') }}">Register here</a></p>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if google_auth_is_configured %}
        <div class="google-auth-container-modifiers">
            <p>OR</p>
            <a href="{{ url_for('google_initiate_login_route') }}" class="google-login-button">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
                Login with Google
            </a>
        </div>
        {% endif %}
    </main>

    {% elif show_character_selection %}
    <main class="character-selection-container centered-content">
        <h2>Select Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <ul role="list">
            {% for char_info in characters_for_selection %}
            <li role="listitem">
                <span>{{ char_info.name }} (Level {{ char_info.level }})</span>
                {% if char_info.is_dead %}
                    <span class="status-deceased">DECEASED</span>
                {% else %}
                    <a href="{{ url_for('select_character_route', slot_index=char_info.slot_index) }}" class="action-button">Select</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        {% if characters_for_selection | length < MAX_CHARS_PER_USER %}
            <p><a href="{{ url_for('display_game_output', action='create_new_char') }}" class="create-new-link action-button">Create New Character Slot</a></p>
        {% elif characters_for_selection | length >= MAX_CHARS_PER_USER %}
            <p>All character slots ({{ MAX_CHARS_PER_USER }}) are currently filled. A dead character occupies a slot.</p>
        {% endif %}

        {% if dead_characters_info %}
        <section class="graveyard-container">
            <h3>Graveyard</h3>
            <ul role="list">
                {% for dead_char in dead_characters_info %}
                <li role="listitem">
                    {{ dead_char.name }} (Level {{ dead_char.level }}) - Resting in peace.
                </li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}

         <p class="logout-paragraph-modifiers"><a href="{{ url_for('logout_route') }}">Logout</a></p>
    </main>

    {% elif show_character_creation_form %}
    <main class="character-creation-container centered-content">
        <h2>Create Your Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form id="characterCreationForm" action="{{ url_for('create_character_route') }}" method="post">
            <div>
                <label for="character_name">Character Name:</label>
                <input type="text" id="character_name" name="character_name" value="{{ pending_char_name or '' }}" required>
            </div>

            <h3>Character Stats:</h3>
            {% if character_creation_stats %}
                <p>
                    Your rolled stats are below.
                    {% if not character_creation_stats.reroll_used %}
                        You can reroll <strong>one</strong> stat <strong>once</strong>.
                    {% else %}
                        You have used your reroll.
                    {% endif %}
                </p>
                <div id="stats_container">
                    {% if stat_names_ordered %}
                        {% for stat_key in stat_names_ordered %}
                        {% set stat_value = character_creation_stats.stats[stat_key] %}
                        <div>
                            <span>{{ stat_key }}: {{ stat_value }}</span>
                            {% if not character_creation_stats.reroll_used %}
                            <form action="{{ url_for('reroll_stat_route', stat_name=stat_key) }}" method="POST" class="inline-form">
                                <button type="submit" class="action-button">Reroll {{ stat_key }}</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for stat_key, stat_value in character_creation_stats.stats.items() %}
                        <div>
                            <span>{{ stat_key }}: {{ stat_value }}</span>
                            {% if not character_creation_stats.reroll_used %}
                            <form action="{{ url_for('reroll_stat_route', stat_name=stat_key) }}" method="POST" class="inline-form">
                                <button type="submit" class="action-button">Reroll {{ stat_key }}</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            {% else %}
                <p>Stats not available. Please try starting character creation again.</p>
            {% endif %}

            <div class="character-creation-submit-container">
                <button type="submit" id="createCharacterButton" class="action-button">Create Character</button>
            </div>
        </form>
    </main>
    <script>
        // Script for character creation name persistence during reroll
        document.addEventListener('DOMContentLoaded', function() {
            const statsContainer = document.getElementById('stats_container');
            if (statsContainer) {
                statsContainer.addEventListener('click', function(event) {
                    if (event.target.tagName === 'BUTTON' && event.target.type === 'submit' && event.target.closest('form[action*="/reroll_stat/"]')) {
                        const rerollForm = event.target.closest('form');
                        const characterNameInput = document.getElementById('character_name');
                        if (rerollForm && characterNameInput) {
                            let hiddenInput = rerollForm.querySelector('input[name="character_name"]');
                            if (!hiddenInput) {
                                hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'character_name';
                                rerollForm.appendChild(hiddenInput);
                            }
                            hiddenInput.value = characterNameInput.value;
                        }
                    }
                });
            }
        });
    </script>

    {% else %}
    {# Main Game Interface #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes-container">
            {% for category, message in messages %}
                <p class="flash-{{ category }} flash-message-default">{{ message }}</p>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <div class="game-container">
        <button id="top-right-menu-button" aria-haspopup="true" aria-expanded="false" aria-controls="settings-popup">Menu</button>

        <aside id="left-info-column" class="info-column">
            <section class="mini-panel" id="mini-stats-panel" tabindex="0" role="button" aria-controls="full-stats-panel-container" aria-expanded="false">
                <h4>Stats</h4>
                <p>HP: <span class="mini-hp-value">{{ player_hp }}/{{ player_max_hp }}</span></p>
                <p>Gold: <span class="mini-gold-value">{{ player_gold }} G</span></p>
            </section>
            <div class="full-panel-container hidden" id="full-stats-panel-container" role="dialog" aria-modal="true" aria-labelledby="stats-panel-title">
                <div class="full-panel-content">
                    <button class="close-full-panel" aria-label="Close Stats Panel">&times;</button>
                    <h2 id="stats-panel-title">Player Status</h2>
                    <p><strong>Name:</strong> {{ player_name }}</p>
                    <p><strong>HP:</strong> <span class="full-hp-value">{{ player_hp }}</span> / <span class="full-max-hp-value">{{ player_max_hp }}</span></p>
                    <p><strong>Gold:</strong> <span class="full-gold-value">{{ player_gold }} G</span></p>
                    <p><strong>Stats:</strong></p>
                    <ul role="list">
                        {% for stat, value in player_stats.items() %}
                        <li role="listitem"><strong>{{ stat }}:</strong> {{ value }}</li>
                        {% endfor %}
                    </ul>
                    <p><strong>Skill Points to Allocate:</strong> <span id="skill-points-to-allocate-display">{{ player_skill_points_to_allocate | default(0) }}</span></p>
                    {% if player_skill_points_to_allocate and player_skill_points_to_allocate > 0 %}
                    <button type="button" id="allocate-skill-points-button" class="action-button">Allocate Skill Points</button>
                    {% endif %}
                    {# Placeholder for displaying chosen skill bonuses if needed in future #}
                    {# <p><strong>Chosen Skill Bonuses:</strong></p>
                    <ul role="list" id="chosen-skill-bonuses-display">
                        {% if player_chosen_skill_bonuses %}
                            {% for skill, bonus in player_chosen_skill_bonuses.items() %}
                            <li role="listitem">{{ skill }}: +{{ bonus }}</li>
                            {% endfor %}
                        {% else %}
                            <li role="listitem">None</li>
                        {% endif %}
                    </ul> #}

                    <p><strong>Attunement Slots Used:</strong> {{ player_attunement_slots_used | default(0) }}/{{ player_attunement_slots_max | default(3) }}</p>
                    {% if player_attuned_items %}
                    <p><strong>Attuned Items:</strong></p>
                    <ul role="list" class="attuned-items-list">
                        {% for item in player_attuned_items %}
                        <li role="listitem">
                            {{ item.name }} ({{ item.quality }})
                            <button type="button" class="action-button unattune-item-button" data-item-name="{{ item.name }}">Unattune</button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p><strong>Attuned Items:</strong> None</p>
                    {% endif %}
                </div>
            </div>

            <section class="mini-panel" id="mini-info-panel" tabindex="0" role="button" aria-controls="full-info-panel-container" aria-expanded="false">
                <h4>Info</h4>
                <p>Time: <span class="mini-time-value">{{ current_time }}</span></p>
                <p>Town: <span class="mini-town-value">{{ current_town_name }}</span></p>
            </section>
            <div class="full-panel-container hidden" id="full-info-panel-container" role="dialog" aria-modal="true" aria-labelledby="info-panel-title">
                <div class="full-panel-content">
                    <button class="close-full-panel" aria-label="Close Info Panel">&times;</button>
                    <h2 id="info-panel-title">Game Info</h2>
                    <p><strong>Current Time:</strong> <span class="full-time-value">{{ current_time }}</span></p>
                    <p><strong>Current Town:</strong> <span class="full-town-value">{{ current_town_name }}</span></p>
                </div>
            </div>

            <section class="mini-panel" id="mini-shop-mgt-panel" tabindex="0" role="button" aria-controls="full-shop-mgt-panel-container" aria-expanded="false">
                <h4>Shop Mgt</h4>
                <p>Level: <span class="mini-shop-level-value">{{ shop_data_json.level if shop_data_json else 'N/A' }}</span></p>
            </section>
            <div class="full-panel-container hidden" id="full-shop-mgt-panel-container" role="dialog" aria-modal="true" aria-labelledby="shop-mgt-panel-title">
                <div class="full-panel-content">
                    <button class="close-full-panel" aria-label="Close Shop Management Panel">&times;</button>
                    <h2 id="shop-mgt-panel-title">Shop Management</h2>
                    <div id="shop-management-details">
                        <!-- Content will be populated by JS -->
                    </div>
                </div>
            </div>
        </aside>

        <main id="map-container" aria-label="Game Map and Location Interactions">
            <svg width="100%" height="100%" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" role="img" aria-labelledby="map-title">
              <title id="map-title">Overworld Map</title>
              <rect width="100%" height="100%" fill="#cccccc"></rect>
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="24px" fill="#333333">Overworld Map</text>
            </svg>
            <section id="location-interactions-container" class="action-section" aria-labelledby="current-location-heading">
                <h4 id="current-location-heading">Current Location: <span id="current-town-display-actions">{{ current_town_name }}</span></h4>
                <div id="sub-locations-list" class="button-list" role="list">
                    <!-- JS populates sub-location buttons -->
                </div>
                <div id="current-sub-location-actions-container">
                    <h5 id="current-sub-location-name-display" class="hidden"></h5>
                    <div id="current-sub-location-actions-list" class="button-list" role="list">
                        <!-- JS populates actions for a selected sub-location -->
                    </div>
                </div>
            </section>
        </main>

        <aside id="right-inventory-column" class="info-column">
            <section class="mini-panel" id="mini-inventory-panel" tabindex="0" role="button" aria-controls="full-inventory-panel-container" aria-expanded="false">
                <h4>Inventory</h4>
                <p>Player: <span class="mini-player-item-count">{{ player_inventory | length if player_inventory and player_inventory[0] != "Empty" else 0 }}</span> items</p>
                <p>Shop: <span class="mini-shop-item-count">{{ shop_inventory | length if shop_inventory and shop_inventory[0] != "Empty" else 0 }}</span> items</p>
            </section>
            <div class="full-panel-container hidden" id="full-inventory-panel-container" role="dialog" aria-modal="true" aria-labelledby="inventory-panel-title">
                <div class="full-panel-content">
                    <button class="close-full-panel" aria-label="Close Inventory Panel">&times;</button>
                    <h2 id="inventory-panel-title">Inventory</h2>
                    <section aria-labelledby="shop-stock-heading">
                        <h3 id="shop-stock-heading">Shop Stock</h3>
                        {% if shop_inventory and shop_inventory[0] != "Empty" %}
                        <div class="inventory-grid shop-inventory-grid" role="list">
                            {% for item in shop_inventory %}
                            <div class="inventory-item-card shop-item-card" role="listitem">
                                <div class="item-icon-placeholder" aria-hidden="true"></div>
                                <div class="item-name">
                                    {{ item.name if item is mapping and item.name else item }}
                                </div>
                                <button type="button" class="buy-item-button action-button" data-item-name="{{ item.name if item is mapping and item.name else item }}">Buy</button>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p>Shop inventory is currently empty.</p>
                        {% endif %}
                    </section>

                    <section aria-labelledby="player-items-heading">
                        <h3 id="player-items-heading">Player Items</h3>
                        {% if player_inventory and player_inventory[0] != "Empty" %}
                        <div class="inventory-grid player-inventory-grid" role="list">
                            {% for item in player_inventory %}
                            <div class="inventory-item-card" role="listitem">
                                <div class="item-icon-placeholder" aria-hidden="true"></div>
                                <div class="item-name">
                                    {{ item.name if item is mapping and item.name else item }}
                                    {% if item.quantity and item.quantity > 1 %}
                                        (x{{ item.quantity }})
                                    {% endif %}
                                </div>
                                <div class="item-actions">
                                    {% if item.is_consumable %}
                                        <button type="button" class="action-button use-item-button" data-item-name="{{ item.name if item is mapping and item.name else item }}">Use</button>
                                    {% endif %}
                                    {% if item.is_attunement and (item.name if item is mapping and item.name else item) not in player_attuned_item_names %}
                                        <button type="button" class="action-button attune-item-button" data-item-name="{{ item.name if item is mapping and item.name else item }}">Attune</button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p>Player inventory is empty.</p>
                        {% endif %}
                    </section>
                </div>
            </div>
        </aside>

        <nav id="bottom-bar" aria-label="Main game actions and log tabs">
            <div class="actions-log-tab-buttons" role="tablist">
                <button id="actions-tab-button" role="tab" aria-controls="actions-panel-content" aria-selected="true" class="tab-button active-tab-button">Actions</button>
                <button id="log-tab-button" role="tab" aria-controls="log-panel-content" aria-selected="false" class="tab-button">Log</button>
            </div>
            <div id="bottom-panel-content-area">
                <section id="actions-panel-content" class="panel-content tab-content panel-visible" role="tabpanel" aria-labelledby="actions-tab-button">
                    <div id="action-controls-wrapper">
                        <form id="actionForm" action="{{ url_for('perform_action') }}" method="post">
                            <input type="hidden" id="action_name_hidden" name="action_name" value="">
                            <input type="hidden" id="action_details" name="action_details" value="{}">

                            <section id="travel-actions-container" class="action-section" aria-labelledby="travel-heading">
                                <h4 id="travel-heading">Travel</h4>
                                <div id="map-destinations">
                                    {% if available_towns %}
                                        <p>Choose a destination:</p>
                                        <ul class="button-list" role="list">
                                            {% for town_name_key in available_towns %}
                                            <li role="listitem"><button type="button" class="map-destination-button action-button" data-town-name="{{ town_name_key }}">{{ town_name_key }}</button></li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>No destinations available.</p>
                                    {% endif %}
                                </div>
                            </section>

                            <section id="general-actions-container" class="action-section" aria-labelledby="general-actions-heading">
                                <h4 id="general-actions-heading">General</h4>
                                <ul class="button-list" role="list">
                                    <li role="listitem"><button type="button" id="gatherResourcesButton" class="action-button">Gather Resources</button></li>
                                    <li role="listitem"><button type="button" id="studyLocalHistoryButton" class="action-button">Study Local History</button></li>
                                    <li role="listitem"><button type="button" id="organizeInventoryButton" class="action-button">Organize Inventory</button></li>
                                    <li role="listitem"><button type="button" id="postAdvertisementsButton" class="action-button">Post Advertisements</button></li>
                                    <li role="listitem"><button type="button" id="shortRestButton" class="action-button">Short Rest</button></li>
                                    <li role="listitem"><button type="button" id="longRestButton" class="action-button">Long Rest</button></li>
                                </ul>
                            </section>

                            <section id="dynamic-action-forms-container" class="action-section hidden" aria-live="polite">
                                <div id="div_craft_details" class="dynamic-form details-section hidden" role="region" aria-labelledby="craft-form-heading">
                                    <div class="form-header"><h4 id="craft-form-heading">Craft Item</h4><button type="button" class="close-dynamic-form" aria-label="Close Craft Form">&times;</button></div>
                                    <label for="craft_item_name">Item Name to Craft:</label>
                                    <input type="text" id="craft_item_name" name="craft_item_name_detail_input" placeholder="e.g., Minor Healing Potion">
                                    <button type="button" class="submit-details-button action-button" data-action="craft">Craft It!</button>
                                </div>

                                <div id="div_buy_details" class="dynamic-form details-section hidden" role="region" aria-labelledby="buy-form-heading">
                                    <div class="form-header"><h4 id="buy-form-heading">Buy from Your Shop</h4><button type="button" class="close-dynamic-form" aria-label="Close Buy Form">&times;</button></div>
                                    <label for="buy_item_name">Item Name to Buy:</label>
                                    <input type="text" id="buy_item_name" name="buy_item_name_detail_input" placeholder="e.g., Simple Dagger">
                                    <label for="buy_quantity">Quantity:</label>
                                    <input type="number" id="buy_quantity" name="buy_quantity_detail_input" value="1" min="1">
                                    <button type="button" class="submit-details-button action-button" data-action="buy_from_own_shop">Buy Item(s)</button>
                                </div>

                                <div id="div_sell_details" class="dynamic-form details-section hidden" role="region" aria-labelledby="sell-form-heading">
                                    <div class="form-header"><h4 id="sell-form-heading">Sell to Your Shop</h4><button type="button" class="close-dynamic-form" aria-label="Close Sell Form">&times;</button></div>
                                    <label for="sell_item_dropdown">Select Item from Inventory:</label>
                                    <select id="sell_item_dropdown" name="sell_item_dropdown_select"></select>
                                    <label for="sell_item_name">Or Type Item Name to Sell:</label>
                                    <input type="text" id="sell_item_name" name="sell_item_name_detail_input" placeholder="e.g., Stale Ale (or select from above)">
                                    <button type="button" class="submit-details-button action-button" data-action="sell_to_own_shop">Sell Item</button>
                                </div>

                                <div id="div_hemlock_herbs_details" class="dynamic-form details-section hidden" role="region" aria-labelledby="hemlock-form-heading">
                                    <div class="form-header"><h4 id="hemlock-form-heading">Buy Herbs from Hemlock</h4><button type="button" class="close-dynamic-form" aria-label="Close Hemlock Form">&times;</button></div>
                                    <div id="hemlock-herbs-list" role="list"></div>
                                    <label for="hemlock_quantity_dynamic">Quantity:</label>
                                    <input type="number" id="hemlock_quantity_dynamic" value="1" min="1">
                                    <button type="button" id="submit_buy_hemlock_herb_button" class="action-button">Buy Selected Herb</button>
                                </div>

                                <div id="div_borin_items_details" class="dynamic-form details-section hidden" role="region" aria-labelledby="borin-buy-form-heading">
                                    <div class="form-header"><h4 id="borin-buy-form-heading">Buy from Borin Stonebeard</h4><button type="button" class="close-dynamic-form" aria-label="Close Borin Buy Form">&times;</button></div>
                                    <div id="borin-items-list" role="list"></div>
                                    <label for="borin_quantity_dynamic">Quantity:</label>
                                    <input type="number" id="borin_quantity_dynamic" value="1" min="1">
                                    <button type="button" id="submit_buy_borin_item_button" class="action-button">Buy Selected Item</button>
                                </div>

                                <div id="div_borin_repair_details" class="dynamic-form details-section hidden" role="region" aria-labelledby="borin-repair-form-heading">
                                    <div class="form-header"><h4 id="borin-repair-form-heading">Repair Gear with Borin</h4><button type="button" class="close-dynamic-form" aria-label="Close Borin Repair Form">&times;</button></div>
                                    <label for="borin-repair-item-select">Item to Repair:</label>
                                    <select id="borin-repair-item-select" name="borin_repair_item_select_input"></select>
                                    <p>Repair Cost: <span id="borin-repair-cost-display">N/A</span></p>
                                    <button type="button" id="submit-borin-repair-button" class="action-button">Repair Selected Item</button>
                                </div>
                            </section>
                        </form>
                    </div>
                </section>

                <section id="log-panel-content" class="panel-content tab-content hidden" role="tabpanel" aria-labelledby="log-tab-button">
                    <div class="log-box">
                        <h2>Journal</h2>
                        {% if player_journal %}
                        <ul id="journal-entries-list" role="list">
                            {% for entry in player_journal | reverse %}
                            <li role="listitem">
                                <span class="journal-timestamp">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') if entry.timestamp else 'No timestamp' }}</span>
                                <strong class="journal-action-type">{{ entry.action_type }}</strong>
                                <p class="journal-summary">{{ entry.summary }}</p>
                                {% if entry.details and entry.details is mapping and entry.details | length > 0 %}
                                <div class="journal-details">
                                    <strong>Details:</strong>
                                    <ul role="list">
                                        {% for key, value in entry.details.items() %}
                                        <li role="listitem">{{ key }}: {{ value }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                {% if entry.outcome %}
                                <p class="journal-outcome"><strong>Outcome:</strong> {{ entry.outcome }}</p>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p>No journal entries yet.</p>
                        {% endif %}
                    </div>
                </section>
            </div>
        </nav>

        <div id="settings-popup" role="menu" class="hidden">
            <ul role="none">
                <li id="settings-option" role="menuitem">Settings</li>
                <li role="menuitem"><a href="{{ url_for('logout_route') }}" id="logout-option">Logout</a></li>
                <li role="menuitem"><button type="button" id="save-game-button" class="popup-menu-button action-button">Save Game</button></li>
            </ul>
        </div>
    </div>

    <script>
        // Pass Jinja variables to JavaScript
        window.gameConfig = {
            currentTownSubLocationsJson: {{ current_town_sub_locations_json | default('[]') | safe }},
            allTownsDataJson: {{ all_towns_data_json | default('{}') | safe }},
            hemlockHerbsData: {{ hemlock_herbs_json | default({}) | tojson | safe }},
            borinItemsData: {{ borin_items_json | default({}) | tojson | safe }},
            playerInventory: {{ player_inventory | default('[]') | tojson | safe }},
            awaitingEventChoice: {{ awaiting_event_choice | default('false') | tojson }},
            pendingEventDataJson: {{ pending_event_data_json | tojson | safe }},
            lastSkillRollStr: {{ last_skill_roll_str | tojson | safe }},
            popupActionResult: {{ popup_action_result | tojson | safe }},
            shopData: {{ shop_data_json | default('null') | safe }},
            shopConfig: {{ shop_config_json | default('null') | safe }},
            playerGold: {{ player_gold | default(0) | tojson }},
            playerSkillPointsToAllocate: {{ player_skill_points_to_allocate | default(0) | tojson }},
            playerChosenSkillBonuses: {{ player_chosen_skill_bonuses | default({}) | tojson | safe }},
            characterAttributeDefinitions: {{ character_attribute_definitions_json | default('{}') | safe }},
            performActionUrl: "{{ url_for('perform_action') }}",
            submitEventChoiceUrl: "{{ url_for('submit_event_choice_route') }}"
        };
    </script>
    <script>
        // Add new config for haggling pending status
        window.gameConfig.hagglingPending = {{ haggling_pending | default('false') | tojson }};
        window.gameConfig.pendingHagglingDataJson = {{ pending_haggling_data_json | default('null') | tojson | safe }};
    </script>
    <script src="{{ url_for('static', filename='js/main_ui.js') }}" defer></script>
    {% endif %}

    <div id="subLocationActionsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="subLocationActionsModalTitle">
        <div class="modal-content">
            <button class="close-button" aria-label="Close Sub-location Actions">&times;</button>
            <h3 id="subLocationActionsModalTitle">Actions</h3>
            <div id="modal-actions-list" class="button-list">
                <!-- Action buttons will be dynamically inserted here -->
            </div>
        </div>
    </div>

    {# Haggling Modal #}
    <div id="haggling-popup-wrapper" class="hidden">
        <div id="haggling-popup" class="modal" role="dialog" aria-modal="true" aria-labelledby="haggling-popup-title">
            <div class="modal-content">
                <h3 id="haggling-popup-title">Haggling</h3>
                <div id="haggling-item-info">
                    <p>Item: <span id="haggle-item-name">Item Name</span> (<span id="haggle-item-quality">Quality</span>)</p>
                    <p>Quantity: <span id="haggle-item-quantity">1</span></p>
                </div>
                <p>NPC: <span id="haggle-npc-name">NPC Name</span> (<span id="haggle-npc-mood">Mood</span>)</p>
                <p>Current Offer: <strong id="haggle-current-offer">100g</strong></p>
                <p id="haggle-target-price-info" class="hidden">Your Target: <span id="haggle-player-target-price">Xg</span> | Shop's Target: <span id="haggle-shop-target-price">Yg</span></p>

                <div id="haggle-last-check-result" class="skill-check-result-display hidden">
                    <p>Last Check: <span id="haggle-last-check-text"></span></p>
                </div>

                <div id="haggling-choices-container" class="action-buttons-container button-list">
                    <button type="button" id="haggle-accept-button" class="action-button haggle-choice-button" data-choice="accept">Accept Offer</button>
                    <button type="button" id="haggle-decline-button" class="action-button haggle-choice-button" data-choice="decline">Decline & End</button>
                    <button type="button" id="haggle-persuade-button" class="action-button haggle-choice-button" data-choice="persuade">Attempt Persuasion</button>
                    {# Add Insight/Intimidate buttons here if implemented #}
                </div>
                <p id="haggle-rounds-info">Round <span id="haggle-current-round">1</span>/<span id="haggle-max-rounds">3</span></p>
                <p id="haggle-final-offer-notice" class="hidden">This is their final offer.</p>
            </div>
        </div>
    </div>

    {# ASI/Feat Choice Modal #}
    <div id="asi-feat-choice-popup-wrapper" class="hidden">
        <div id="asi-feat-choice-popup" class="modal" role="dialog" aria-modal="true" aria-labelledby="asi-feat-choice-popup-name">
            <div class="modal-content">
                {# <button class="close-button" id="close-asi-feat-choice-popup" aria-label="Close ASI/Feat Choice">&times;</button> #}
                {# No close button, choice is mandatory if pending #}
                <h3 id="asi-feat-choice-popup-name">Level Up! Choose Your Advancement</h3>

                <div class="asi-feat-main-choice">
                    <p>What would you like to do?</p>
                    <label><input type="radio" name="asi_feat_type_choice" value="asi"> Increase Ability Scores</label>
                    <label><input type="radio" name="asi_feat_type_choice" value="feat"> Select a Feat</label>
                </div>

                <div id="asi-options-container" class="details-section hidden">
                    <h4>Increase Ability Scores</h4>
                    <label><input type="radio" name="asi_increase_type" value="plus_two"> +2 to one Ability Score</label>
                    <label><input type="radio" name="asi_increase_type" value="plus_one_one"> +1 to two different Ability Scores</label>

                    <div id="asi-plus-two-options" class="details-subsection hidden">
                        <label for="asi_plus_two_stat">Select Stat for +2:</label>
                        <select id="asi_plus_two_stat" class="themed-select">
                            <option value="">-- Select Stat --</option>
                            <option value="STR">Strength (STR)</option>
                            <option value="DEX">Dexterity (DEX)</option>
                            <option value="CON">Constitution (CON)</option>
                            <option value="INT">Intelligence (INT)</option>
                            <option value="WIS">Wisdom (WIS)</option>
                            <option value="CHA">Charisma (CHA)</option>
                        </select>
                    </div>

                    <div id="asi-plus-one-one-options" class="details-subsection hidden">
                        <div>
                            <label for="asi_plus_one_stat1">Select First Stat for +1:</label>
                            <select id="asi_plus_one_stat1" class="themed-select">
                                <option value="">-- Select Stat --</option>
                                <option value="STR">Strength (STR)</option>
                                <option value="DEX">Dexterity (DEX)</option>
                                <option value="CON">Constitution (CON)</option>
                                <option value="INT">Intelligence (INT)</option>
                                <option value="WIS">Wisdom (WIS)</option>
                                <option value="CHA">Charisma (CHA)</option>
                            </select>
                        </div>
                        <div>
                            <label for="asi_plus_one_stat2">Select Second Stat for +1:</label>
                            <select id="asi_plus_one_stat2" class="themed-select">
                                <option value="">-- Select Stat --</option>
                                <option value="STR">Strength (STR)</option>
                                <option value="DEX">Dexterity (DEX)</option>
                                <option value="CON">Constitution (CON)</option>
                                <option value="INT">Intelligence (INT)</option>
                                <option value="WIS">Wisdom (WIS)</option>
                                <option value="CHA">Charisma (CHA)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="feat-options-container" class="details-section hidden">
                    <h4>Select a Feat</h4>
                    <div id="feat-selection-list" class="scrollable-list" role="radiogroup" aria-labelledby="feat-selection-heading">
                        <!-- Feats will be populated by JavaScript -->
                        <p>Loading feats...</p>
                    </div>
                </div>

                <button type="button" id="confirm-asi-feat-choice-button" class="action-button" disabled>Confirm Choice</button>
            </div>
        </div>
    </div>

    {# Conditionally render event popup wrapper only if needed, JS still controls final visibility via .hidden #}
    {% if awaiting_event_choice and pending_event_data_json %}
    <div id="event-choice-popup-wrapper"> {# Wrapper to allow JS to control the .modal itself if needed #}
        <div id="event-choice-popup" class="modal" role="dialog" aria-modal="true" aria-labelledby="event-popup-name">
            <div class="modal-content">
                <h3 id="event-popup-name">Event Title</h3>
                <p id="event-popup-description"></p>
                <div id="event-popup-choices" class="action-buttons-container button-list">
                    <!-- Choices will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>

    {# Skill Allocation Modal #}
    <div id="skill-allocation-popup-wrapper" class="hidden"> {# Wrapper to control visibility via JS if needed, initially hidden #}
        <div id="skill-allocation-popup" class="modal" role="dialog" aria-modal="true" aria-labelledby="skill-allocation-popup-name">
            <div class="modal-content">
                <button class="close-button" id="close-skill-allocation-popup" aria-label="Close Skill Allocation">&times;</button>
                <h3 id="skill-allocation-popup-name">Allocate Skill Point</h3>
                <p>You have <span id="skill-points-available-modal-display">0</span> point(s) to spend.</p>
                <p>Choose a skill to improve by +1:</p>
                <div id="skill-allocation-choices" class="action-buttons-container button-list" role="list">
                    <!-- Skill buttons will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
