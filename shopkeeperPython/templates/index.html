<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopkeeper Adventure UI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden-details {
            display: none;
            margin-top: 10px;
        }
        .details-section label {
            display: block;
            margin-top: 5px;
        }
        .details-section input {
            width: calc(100% - 10px);
            padding: 5px;
            margin-top: 2px;
        }
        /* Styles for character creation */
        .character-creation-container {
            width: 50%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .character-creation-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .character-creation-container div {
            margin-bottom: 10px;
        }
        .character-creation-container label {
            display: inline-block;
            width: 150px;
        }
        .character-creation-container input[type="text"],
        .character-creation-container input[type="number"] { /* Added number for consistency if used later */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 170px); /* Adjust based on label width and padding */
        }
        .character-creation-container button, .login-container button, .google-login-button {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            text-decoration: none;
            display: inline-block;
            line-height: normal;
        }
        .login-container button {
            background-color: #007bff;
        }
        .character-creation-container button {
             background-color: #007bff;
        }
        /* Individual hover effects */
        .login-container button:hover {
            background-color: #0056b3;
        }
        .character-creation-container button:hover {
            background-color: #0056b3;
        }
        .google-login-button {
            background-color: #4285F4;
            margin-left: 0;
        }
        .google-login-button:hover {
            background-color: #357ae8;
        }
        .google-login-button img {
            width: 18px;
            height: 18px;
            vertical-align: middle;
            margin-right: 10px;
        }
        .character-creation-container button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* Styles for login container */
        .login-container {
            width: 300px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center;
        }
        .login-container h2 {
            margin-bottom: 20px;
        }
        .login-container input[type="text"],
        .login-container input[type="password"] {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .login-container p {
            margin-top: 15px;
        }

        /* Styles for character selection */
        .character-selection-container {
            width: 50%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center; /* Center h2 and p */
        }
        .character-selection-container h2 {
            margin-bottom: 20px;
        }
        .character-selection-container ul {
            list-style-type: none;
            padding: 0;
        }
        .character-selection-container li {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .character-selection-container li a {
            text-decoration: none;
            padding: 8px 15px;
            background-color: #28a745; /* Green for select */
            color: white;
            border-radius: 4px;
        }
        .character-selection-container li a:hover {
            background-color: #218838;
        }
        .character-selection-container .create-new-link {
            display: inline-block; /* To allow margin auto if needed, or just text-align center on parent */
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #007bff; /* Blue for create new */
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .character-selection-container .create-new-link:hover {
            background-color: #0056b3;
        }

        /* Styles for graveyard container */
        .graveyard-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }
        .graveyard-container h3 {
            margin-bottom: 15px;
            color: #555;
        }
        .graveyard-container ul {
            list-style-type: none;
            padding: 0;
        }
        .graveyard-container li {
            background-color: #e9ecef; /* Light grey background for dead chars */
            color: #495057; /* Darker text for contrast */
            padding: 8px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        .character-creation-container #stats_container div {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
        }
        .character-creation-container #stats_container span {
            flex-grow: 1;
        }

        /* Action Result Popup Styles */
        #action-result-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        #action-result-popup #close-popup-button {
            display: block;
            margin-top: 15px;
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            float: right; /* Or use flexbox on a parent for better alignment */
        }
        #action-result-popup #close-popup-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    {% if not user_logged_in %}
    <div class="login-container">
        <h2>Login</h2>
        <form action="{{ url_for('login_route') }}" method="post">
            <div>
                <input type="text" name="username" placeholder="Username" required>
            </div>
            <div>
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="{{ url_for('register_page') }}">Register here</a></p>
        {# Display ALL flash messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if google_auth_is_configured %}
        <div style="margin-top: 20px; text-align: center;">
            <p>OR</p>
            <a href="{{ url_for('google_initiate_login_route') }}" class="google-login-button">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
                Login with Google
            </a>
        </div>
        {% endif %}
    </div>

    {% elif show_character_selection %}
    <div class="character-selection-container">
        <h2>Select Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %} {# Show flashes here too #}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <ul>
            {% for char_info in characters_for_selection %}
            <li>
                <span>{{ char_info.name }} (Level {{ char_info.level }})</span>
                {% if char_info.is_dead %}
                    <span style="color: red; font-weight: bold;">DECEASED</span>
                {% else %}
                    <a href="{{ url_for('select_character_route', slot_index=char_info.slot_index) }}">Select</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {# The logic for showing "Create New Character" link:
           A user can always attempt to go to the creation screen if they have less than MAX_CHARS_PER_USER *total* slots filled.
           The app.py's /create_character route will enforce the final check on whether a new character can actually be stored.
           The display_game_output with action='create_new_char' also checks slot availability before showing the form.
        #}
        {% if characters_for_selection | length < MAX_CHARS_PER_USER %}
            <p><a href="{{ url_for('display_game_output', action='create_new_char') }}" class="create-new-link">Create New Character Slot</a></p>
        {% elif characters_for_selection | length >= MAX_CHARS_PER_USER %}
            <p>All character slots ({{ MAX_CHARS_PER_USER }}) are currently filled. A dead character occupies a slot.</p>
            {# Optionally, if we wanted to allow replacing a dead character (more complex):
               {% set living_chars = characters_for_selection | selectattr('is_dead', 'false') | list %}
               {% if living_chars | length < MAX_CHARS_PER_USER and (characters_for_selection | length == MAX_CHARS_PER_USER) %}
                 <p><a href="{{ url_for('display_game_output', action='create_new_char_replace_dead_prompt_logic_needed_in_app_py') }}" class="create-new-link">Create New Character (Replace Dead)</a></p>
               {% endif %}
            #}
        {% endif %}

        {% if dead_characters_info %}
        <div class="graveyard-container">
            <h3>Graveyard</h3>
            <ul>
                {% for dead_char in dead_characters_info %}
                <li>
                    {{ dead_char.name }} (Level {{ dead_char.level }}) - Resting in peace.
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

         <p style="margin-top: 20px;"><a href="{{ url_for('logout_route') }}">Logout</a></p>
    </div>

    {% elif show_character_creation_form %}
    <div class="character-creation-container">
        <h2>Create Your Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %} {# And here #}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form id="characterCreationForm" action="{{ url_for('create_character_route') }}" method="post">
            <div>
                <label for="character_name">Character Name:</label>
                <input type="text" id="character_name" name="character_name" required>
            </div>

            <h3>Character Stats:</h3>
            <h3>Character Stats:</h3>
            {% if character_creation_stats %}
                <p>
                    Your rolled stats are below.
                    {% if not character_creation_stats.reroll_used %}
                        You can reroll <strong>one</strong> stat <strong>once</strong>.
                    {% else %}
                        You have used your reroll.
                    {% endif %}
                </p>
                <div id="stats_container">
                    {% for stat_key, stat_value in character_creation_stats.stats.items() %}
                    <div>
                        <span>{{ stat_key }}: {{ stat_value }}</span>
                        {% if not character_creation_stats.reroll_used %}
                        <form action="{{ url_for('reroll_stat_route', stat_name=stat_key) }}" method="POST" style="display: inline;">
                            <button type="submit">Reroll {{ stat_key }}</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Stats not available. Please try starting character creation again.</p>
            {% endif %}

            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" id="createCharacterButton">Create Character</button>
            </div>
        </form>
    </div>
    {# Removed the old JavaScript for client-side stat rolling and rerolling.
       The backend now handles this via session. #}

    {% else %}
    {# Main Game Interface #}
    <div class="game-container">
        <div id="top-right-menu-button">Menu</div>

        <div id="left-tabs-container">
            <div id="stats-tab">
                <div id="stats-content" class="tab-content">
                    <div class="tab-title-bar">Stats</div>
                    <h2>Player Status</h2>
                    <p><strong>Name:</strong> {{ player_name }}</p>
                    <p><strong>HP:</strong> {{ player_hp }} / {{ player_max_hp }}</p>
                    <p><strong>Gold:</strong> {{ player_gold }} G</p>
                    <p><strong>Stats:</strong></p>
                    <ul>
                        {% for stat, value in player_stats.items() %}
                        <li><strong>{{ stat }}:</strong> {{ value }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div id="info-tab">
                <div id="info-content" class="tab-content">
                    <div class="tab-title-bar">Info</div>
                    <h2>Game Info</h2>
                    <p><strong>Current Time:</strong> {{ current_time }}</p>
                    <p><strong>Current Town:</strong> {{ current_town_name }}</p>
                </div>
            </div>
        </div>
        <div id="map-container">
            <svg width="100%" height="100%" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
              <rect width="100%" height="100%" fill="#cccccc" />
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="24px" fill="#333333">Overworld Map</text>
            </svg>
        </div>
        <div id="inventory-tab">
            <div id="inventory-content" class="tab-content">
                <div class="tab-title-bar">Inventory</div>
                <h2>Shop Inventory</h2>
                {% if shop_inventory and shop_inventory[0] != "Empty" %}
                <ul>
                    {% for item_display_name in shop_inventory %}
                    <li>{{ item_display_name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Empty</p>
                {% endif %}

                <h2>Player Inventory</h2>
                {% if player_inventory and player_inventory[0] != "Empty" %}
                <ul>
                    {% for item_name in player_inventory %}
                    <li>{{ item_name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Empty</p>
                {% endif %}
            </div>
        </div>
        <div id="actions-tab">
            <div class="actions-log-tab-buttons">
                <div id="actions-tab-button">Actions</div>
                <div id="log-tab-button">Log</div>
            </div>
            <div id="actions-content" class="tab-content">

                <div id="actions-panel-content"> <!-- Panel for Actions -->
                    <div id="action-controls-wrapper">
                        <!-- All original form elements and action sections MUST be HERE -->
                        <form id="actionForm" action="{{ url_for('perform_action') }}" method="post">
                            <input type="hidden" id="action_name_hidden" name="action_name" value="">
                            <input type="hidden" id="action_details" name="action_details" value="{}">
                            <!-- ... other hidden inputs if any ... -->

                            <div id="world-map-container" class="action-box-section">
                                <h2>World Map</h2>
                                <div id="map-destinations">
                                    {% if available_towns %}
                                        <p>Choose a destination to travel to:</p>
                                        <ul>
                                            {% for town_name_key in available_towns %}
                                            <li><button class="map-destination-button" data-town-name="{{ town_name_key }}">{{ town_name_key }}</button></li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>No destinations available.</p>
                                    {% endif %}
                                </div>
                            </div>


                            <div id="current-location-container" class="action-box-section">
                                <h2>Current Location: <span id="current-town-display">{{ current_town_name }}</span></h2>
                                <div id="sub-locations-list">
                                    <!-- Sub-locations of the current town will be populated here by JavaScript -->
                                </div>
                                <div id="current-actions-list">
                                    <!-- Actions for the selected sub-location will be populated here by JavaScript -->
                                </div>
                            </div>

                            <!-- Container for Action Detail Forms -->
                            <div id="action-details-container" class="action-box-section" style="flex-basis: 100%; display: none;"> <!-- Initially hidden, spans full width if flex items wrap -->
                                <h3>Action Details</h3>

                                <div id="div_craft_details" class="hidden-details details-section">
                                    <h4>Craft Item</h4>
                                    <label for="craft_item_name">Item Name to Craft:</label>
                                    <input type="text" id="craft_item_name" name="craft_item_name_detail_input" placeholder="e.g., Minor Healing Potion">
                                    <button type="button" class="submit-details-button" data-action="craft">Craft It!</button>
                                </div>

                                <div id="div_buy_details" class="hidden-details details-section">
                                    <h4>Buy from Your Shop</h4>
                                    <label for="buy_item_name">Item Name to Buy:</label>
                                    <input type="text" id="buy_item_name" name="buy_item_name_detail_input" placeholder="e.g., Simple Dagger">
                                    <label for="buy_quantity">Quantity:</label>
                                    <input type="number" id="buy_quantity" name="buy_quantity_detail_input" value="1" min="1">
                                    <button type="button" class="submit-details-button" data-action="buy_from_own_shop">Buy Item(s)</button>
                                </div>

                                <div id="div_sell_details" class="hidden-details details-section">
                                    <h4>Sell to Your Shop</h4>
                                    <label for="sell_item_name">Item Name to Sell:</label>
                                    <input type="text" id="sell_item_name" name="sell_item_name_detail_input" placeholder="e.g., Stale Ale">
                                    <button type="button" class="submit-details-button" data-action="sell_to_own_shop">Sell Item</button>
                                </div>

                                <div id="div_hemlock_herbs_details" class="hidden-details details-section">
                                    <h4>Buy Herbs from Hemlock</h4>
                                    <div id="hemlock-herbs-list"></div>
                                    <label for="hemlock_quantity_dynamic">Quantity:</label>
                                    <input type="number" id="hemlock_quantity_dynamic" value="1" min="1">
                                    <button type="button" id="submit_buy_hemlock_herb_button">Buy Selected Herb</button>
                                </div>
                            </div>

                            <!-- Gather Resources Button -->
                            <div class="action-box-section">
                                <h3>General Actions</h3>
                                <button type="button" id="gatherResourcesButton" class="general-action-button">Gather Resources</button>
                                <!-- Add other general town/area actions here if needed -->
                            </div>
                        </form> <!-- Close actionForm -->
                    </div> <!-- Close action-controls-wrapper -->
                </div> <!-- Close actions-panel-content -->

                <div id="log-panel-content"> <!-- Panel for Log -->
                    <div class="log-box">
                        <h2>Game Log</h2>
                        <div id="game-output" style="white-space: pre-wrap; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                            {{ game_output | safe }}
                        </div>
                    </div>

                </div> <!-- Close log-panel-content -->
            </div> <!-- Close actions-content -->
        </div> <!-- Close actions-tab -->

        <div id="settings-popup" style="display: none;">
            <ul>
                <li id="settings-option">Settings</li>
                <li><a href="{{ url_for('logout_route') }}" id="logout-option">Logout</a></li>
                <li id="save-game-option">Save Game</li>
            </ul>
        </div>



        <!--
        <h1>Shopkeeper Adventure</h1>

        <div class="container">
            <div class="status-container">
                <!-- Player Status was here -->

                <!-- Game Info was here -->
            </div>

            <div class="inventory-container">
                <!-- Shop Inventory was here -->
                <!-- Player Inventory was here -->
            </div>

            <! -- Available Crafting Recipes Section -- >
            <div class="crafting-recipes-container action-box-section"> <!-- Reusing action-box-section for some styling -- >
                <h2>Available Crafting Recipes</h2>
                {% if available_recipes and available_recipes | length > 0 %}
                    <ul id="crafting-recipes-list">
                        {% for recipe_name, details in available_recipes.items() %}
                        <li>
                            <strong>{{ recipe_name }}</strong>
                            <p><em>Produces: {{ details.quantity_produced }}</em></p>
                            <p>Ingredients:
                                {% for item, quantity in details.ingredients.items() %}
                                    {{ item }} ({{ quantity }}){% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            <button class="craft-recipe-button" data-item-name="{{ recipe_name }}">Craft</button>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No crafting recipes available or known.</p>
                {% endif %}
            </div>
        </div>

        <div class="log-action-container">
            <!-- log-box was here -->
            <!-- action-box contents were moved into #action-controls-wrapper -->

        </div>
        -->
    </div>

    <script>
    // Main game interface script (relevant only if this block is rendered)
    // Ensure this script is placed after the HTML elements it interacts with, or wrapped in DOMContentLoaded.
    // For simplicity with Jinja, variables are passed here.
    var currentTownSubLocations = {{ current_town_sub_locations_json | default('[]') | safe }}; // May not be strictly needed if allTownsData is comprehensive
    var allTownsData = {{ all_towns_data_json | default('{}') | safe }};
    var hemlockHerbsData = {};
    try {
        const hemlockJson = '{{ hemlock_herbs_json | safe }}';
        if (hemlockJson) {
            hemlockHerbsData = JSON.parse(hemlockJson);
        }
    } catch (e) {
        console.error("Error parsing Hemlock's herbs JSON:", e);
        // hemlockHerbsData remains {}
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Existing script for actionForm, map, sub-locations etc.
        if (document.getElementById('actionForm')) {
            const actionForm = document.getElementById('actionForm');
            const hiddenActionNameInput = document.getElementById('action_name_hidden');
            const hiddenDetailsInput = document.getElementById('action_details');

            const mapDestinationsDiv = document.getElementById('map-destinations');
            const subLocationsListDiv = document.getElementById('sub-locations-list');
            // const currentActionsListDiv = document.getElementById('current-actions-list'); // No longer primary target for displayActions
            let currentActionsListDiv = document.getElementById('current-actions-list'); // Keep for event listener for now
            const currentTownDisplay = document.getElementById('current-town-display');

            // Modal elements
            const subLocationActionsModal = document.getElementById('subLocationActionsModal');
            const modalActionsListDiv = document.getElementById('modal-actions-list');
            const modalCloseButton = subLocationActionsModal ? subLocationActionsModal.querySelector('.close-button') : null;


            // Action Detail Divs and Inputs
            const actionDetailsContainer = document.getElementById('action-details-container');
            const craftDetailsDiv = document.getElementById('div_craft_details');
            const craftItemNameInput = document.getElementById('craft_item_name');
            const buyDetailsDiv = document.getElementById('div_buy_details');
            const buyItemNameInput = document.getElementById('buy_item_name');
            const buyQuantityInput = document.getElementById('buy_quantity');
            const sellDetailsDiv = document.getElementById('div_sell_details');
            const sellItemNameInput = document.getElementById('sell_item_name');
            const hemlockHerbsDetailsDiv = document.getElementById('div_hemlock_herbs_details');
            const hemlockHerbsListDiv = document.getElementById('hemlock-herbs-list'); // New div for list

            const allDetailDivs = [craftDetailsDiv, buyDetailsDiv, sellDetailsDiv, hemlockHerbsDetailsDiv];
            let currentActionRequiringDetails = null;
            let currentSubLocationName = null;
            let selectedHemlockHerbName = null; // To store the selected Hemlock herb

            function hideAllDetailForms() {
                if (actionDetailsContainer) actionDetailsContainer.style.display = 'none';
                allDetailDivs.forEach(div => { if (div) div.style.display = 'none'; });
            }

            function displaySubLocations(subLocations) {
                if (!subLocationsListDiv) return;
                subLocationsListDiv.innerHTML = '';
                if (currentActionsListDiv) currentActionsListDiv.innerHTML = '';
                hideAllDetailForms(); // Also hide detail forms when sub-locations are re-rendered

                if (subLocations && subLocations.length > 0) {
                    const ul = document.createElement('ul');
                    subLocations.forEach(subLoc => {
                        const li = document.createElement('li');
                        const button = document.createElement('button');
                        button.type = 'button'; // <--- ADD THIS LINE
                        button.className = 'sub-location-button';
                        button.dataset.sublocName = subLoc.name;
                        button.textContent = subLoc.name;
                        li.appendChild(button);
                        if (subLoc.description) {
                            li.append(` - ${subLoc.description}`);
                        }
                        ul.appendChild(li);
                    });
                    subLocationsListDiv.appendChild(ul);
                } else {
                    subLocationsListDiv.innerHTML = '<p>No sub-locations here.</p>';
                }
            }

            // Function to display actions for a selected sub-location
            function displayActions(subLocName) {
                // if (!currentActionsListDiv) return; // Old target
                // currentActionsListDiv.innerHTML = ''; // Clear previous
                if (!modalActionsListDiv || !subLocationActionsModal) {
                    console.error("Modal elements not found for displayActions");
                    return;
                }
                modalActionsListDiv.innerHTML = ''; // Clear previous modal actions
                currentSubLocationName = subLocName; // Store the sub-location name

                const currentTownName = currentTownDisplay ? currentTownDisplay.textContent : null;
                if (!currentTownName || !allTownsData || !allTownsData[currentTownName] || !allTownsData[currentTownName].sub_locations) {
                    console.error("Could not find current town data or sub-locations for action display.");
                    return;
                }
                const subLocationsData = allTownsData[currentTownName].sub_locations;


                const selectedSubLocation = subLocationsData.find(sl => sl.name === subLocName);

                if (selectedSubLocation && selectedSubLocation.actions && selectedSubLocation.actions.length > 0) {
                    const ul = document.createElement('ul');
                    selectedSubLocation.actions.forEach(actionStr => {
                        const li = document.createElement('li');
                        const button = document.createElement('button');
                        button.className = 'action-button'; // Keep class for existing event listeners
                        button.dataset.actionName = actionStr;
                        button.textContent = actionStr.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Prettify
                        li.appendChild(button);
                        ul.appendChild(li);
                    });
                    modalActionsListDiv.appendChild(ul);
                    subLocationActionsModal.style.display = 'block'; // Show modal
                } else {
                    modalActionsListDiv.innerHTML = '<p>No actions available here.</p>';
                    subLocationActionsModal.style.display = 'block'; // Show modal even if no actions, to indicate it was opened
                }
            }

            // Modal Close Functionality
            if (modalCloseButton) {
                modalCloseButton.addEventListener('click', function() {
                    if (subLocationActionsModal) subLocationActionsModal.style.display = 'none';
                });
            }

            if (subLocationActionsModal) {

                // REMOVED:
                // window.addEventListener('click', function(event) {
                //     if (event.target == subLocationActionsModal) { // Clicked outside of the modal content
                //         subLocationActionsModal.style.display = 'none';
                //     }
                // });

                // ADDED:
                subLocationActionsModal.addEventListener('click', function(event) {
                    // If the click is directly on the modal backdrop (event.target is the modal itself)
                    // then close the modal.
                    if (event.target === subLocationActionsModal) {

                        subLocationActionsModal.style.display = 'none';
                    }
                });
            }

            // Event Listener for Map Destination Buttons
            if (mapDestinationsDiv) {
                mapDestinationsDiv.addEventListener('click', function(event) {
                    if (event.target.classList.contains('map-destination-button')) {
                        const townName = event.target.dataset.townName;
                        if (hiddenActionNameInput) hiddenActionNameInput.value = 'travel_to_town';
                        if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify({ town_name: townName });
                        if (actionForm) actionForm.submit();
                    }
                });
            }

            // Event Listener for Sub-location Buttons
            if (subLocationsListDiv) {
                subLocationsListDiv.addEventListener('click', function(event) {
                    if (event.target.classList.contains('sub-location-button')) {
                        const subLocName = event.target.dataset.sublocName;
                        displayActions(subLocName);
                    }
                });
            }

            // Event Listener for Action Buttons (now potentially inside modal or other containers)
            // This listener should be attached to a static parent that exists at load time,
            // or re-evaluate if currentActionsListDiv is still the correct parent for all actions.
            // For now, we assume action buttons are still eventually handled if they bubble up
            // or if the modal's content is part of a structure listened to by 'currentActionsListDiv's parent.
            // Let's refine this: if actions are ONLY in the modal, this listener needs to be on modalActionsListDiv or its parent.
            // However, the original setup might have used event delegation on a higher-up container.
            // The most robust change is to make the listener target the modal if that's where buttons are now.
            // For the subtask, the buttons are moved to `modal-actions-list`.
            // So, the listener for these specific buttons should be on `modalActionsListDiv`.
            // The old `currentActionsListDiv` might still be used for other things or might become obsolete for this.

            const actionButtonClickHandler = function(event) {
                if (event.target.classList.contains('action-button')) {
                    const actionName = event.target.dataset.actionName;
                    // Hide the modal if an action button inside it is clicked
                    if (subLocationActionsModal && subLocationActionsModal.contains(event.target)) {
                        subLocationActionsModal.style.display = 'none';
                    }
                        hideAllDetailForms(); // Hide any open detail forms first
                        currentActionRequiringDetails = null; // Reset

                        if (hiddenActionNameInput) hiddenActionNameInput.value = actionName; // Set action name for the form

                        // Check if this action is 'craft' AND if it's coming from the dynamic action list
                        // vs. the new recipe list. The new recipe list buttons are handled separately.
                        // The original 'craft' action button (if any existed in sub-locations)
                        // would show the generic craft details form.
                        if (actionName === 'craft' && !event.target.classList.contains('craft-recipe-button')) {
                            if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                            if (craftDetailsDiv) craftDetailsDiv.style.display = 'block'; // Show generic craft input
                            currentActionRequiringDetails = actionName;
                            // Do NOT submit form yet for generic craft
                        } else if (actionName === 'buy_from_own_shop') {
                            if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                            if (buyDetailsDiv) buyDetailsDiv.style.display = 'block';
                            currentActionRequiringDetails = actionName;
                            // Do NOT submit form yet
                        } else if (actionName === 'sell_to_own_shop') {
                            if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                            if (sellDetailsDiv) sellDetailsDiv.style.display = 'block';
                            currentActionRequiringDetails = actionName;
                            // Do NOT submit form yet
                        } else if (actionName === 'buy_from_npc' && currentSubLocationName === "Old Man Hemlock's Hut") {
                            if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                            if (hemlockHerbsDetailsDiv) hemlockHerbsDetailsDiv.style.display = 'block';
                            currentActionRequiringDetails = actionName;
                            selectedHemlockHerbName = null; // Reset selection when showing the list
                            if (hemlockHerbsListDiv) {
                                hemlockHerbsListDiv.innerHTML = ''; // Clear previous list
                                if (hemlockHerbsData && Object.keys(hemlockHerbsData).length > 0) {
                                    const ul = document.createElement('ul');
                                    ul.style.listStyleType = 'none'; // Optional: remove bullets
                                    ul.style.paddingLeft = '0'; // Optional: remove default padding
                                    for (const herbKey in hemlockHerbsData) {
                                        const herb = hemlockHerbsData[herbKey];
                                        const li = document.createElement('li');
                                        li.style.marginBottom = '10px'; // Optional: spacing
                                        li.innerHTML = `
                                            <strong>${herb.name}</strong> - ${herb.price}G<br>
                                            <em>${herb.description}</em><br>
                                            <button type="button" class="select-hemlock-herb-button" data-herb-name="${herb.name}">Select</button>
                                        `;
                                        ul.appendChild(li);
                                    }
                                    hemlockHerbsListDiv.appendChild(ul);
                                } else {
                                    hemlockHerbsListDiv.innerHTML = '<p>No herbs available from Hemlock at this time.</p>';
                                }
                            }
                        } else if (!event.target.classList.contains('craft-recipe-button')) {
                            // For actions not needing details from the dynamic list
                            if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify({});
                            if (actionForm) actionForm.submit();
                        }
                    }
            };

            // Attach the handler to the modal list for actions populated by displayActions
            if (modalActionsListDiv) {
                modalActionsListDiv.addEventListener('click', actionButtonClickHandler);
            }

            // If currentActionsListDiv is still used for other buttons (e.g. not from displayActions),
            // it needs its own listener or a shared one if they are in a common parent.
            // For now, assuming actions from displayActions are the primary concern for the modal.
            // If currentActionsListDiv was only for sub-location actions, it might not need a listener anymore
            // if all sub-location actions now go to the modal.
            // Let's keep its original listener for now, in case it handles other dynamically added buttons
            // that are NOT part of sub-location actions.
             if (currentActionsListDiv) {
                currentActionsListDiv.addEventListener('click', actionButtonClickHandler);
             }


            // Event Listener for the new Craft Recipe Buttons
            const craftingRecipesList = document.getElementById('crafting-recipes-list');
            if (craftingRecipesList) {
                craftingRecipesList.addEventListener('click', function(event) {
                    if (event.target.classList.contains('craft-recipe-button')) {
                        const itemName = event.target.dataset.itemName;
                        if (hiddenActionNameInput) hiddenActionNameInput.value = 'craft';
                        if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify({ item_name: itemName });
                        if (actionForm) actionForm.submit();
                    }
                });
            }

            // Event Listener for the Gather Resources Button
            const gatherResourcesButton = document.getElementById('gatherResourcesButton');
            if (gatherResourcesButton) {
                gatherResourcesButton.addEventListener('click', function() {
                    if (hiddenActionNameInput) hiddenActionNameInput.value = 'gather_resources';
                    if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify({}); // Empty details
                    if (actionForm) actionForm.submit();
                });
            }

            function compileAndSetActionDetails() {
                let details = {};
                if (!currentActionRequiringDetails) return; // Should not happen if a detail submit button was clicked

                switch (currentActionRequiringDetails) {
                    case 'craft':
                        if (craftItemNameInput && craftItemNameInput.value) {
                            details.item_name = craftItemNameInput.value;
                        }
                        break;
                    case 'buy_from_own_shop':
                        if (buyItemNameInput && buyItemNameInput.value) {
                            details.item_name = buyItemNameInput.value;
                        }
                        if (buyQuantityInput && buyQuantityInput.value) {
                            details.quantity = parseInt(buyQuantityInput.value, 10);
                        }
                        break;
                    case 'sell_to_own_shop':
                        if (sellItemNameInput && sellItemNameInput.value) {
                            details.item_name = sellItemNameInput.value;
                        }
                        break;
                    // Case for 'buy_from_npc' (Old Man Hemlock) will be handled by its own button listener,
                    // as it needs to capture the selected herb, which isn't part of this generic function.
                    // This function is for the generic ".submit-details-button"s.
                }
                if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify(details);
            }

            // Event Listener for "Submit Details" buttons within each detail form (generic ones)
            if (actionDetailsContainer) {
                actionDetailsContainer.addEventListener('click', function(event) {
                    if (event.target.classList.contains('submit-details-button')) { // Generic submit buttons
                        if (!currentActionRequiringDetails) {
                            console.error("Submit details button clicked but no currentActionRequiringDetails is set.");
                            return;
                        }
                        compileAndSetActionDetails();
                        if (actionForm) actionForm.submit();
                    }
                });
            }

            // Event listener for selecting a Hemlock herb
            if (hemlockHerbsListDiv) {
                hemlockHerbsListDiv.addEventListener('click', function(event) {
                    if (event.target.classList.contains('select-hemlock-herb-button')) {
                        selectedHemlockHerbName = event.target.dataset.herbName;
                        // Optional: Visual feedback for selection
                        document.querySelectorAll('.select-hemlock-herb-button').forEach(btn => {
                            btn.style.fontWeight = 'normal'; // Reset others
                            btn.style.backgroundColor = '';
                        });
                        event.target.style.fontWeight = 'bold'; // Highlight selected
                        event.target.style.backgroundColor = '#a0d2a0'; // Light green highlight
                        console.log("Selected herb: " + selectedHemlockHerbName);
                    }
                });
            }

            // Specific listener for "Buy Selected Herb" button from Hemlock's details
            const submitBuyHemlockHerbButton = document.getElementById('submit_buy_hemlock_herb_button');
            const hemlockQuantityInput = document.getElementById('hemlock_quantity_dynamic');

            if (submitBuyHemlockHerbButton && hemlockQuantityInput) {
                submitBuyHemlockHerbButton.addEventListener('click', function() {
                    if (!selectedHemlockHerbName) {
                        alert("Please select an herb to buy.");
                        return;
                    }
                    const quantity = parseInt(hemlockQuantityInput.value, 10);
                    if (isNaN(quantity) || quantity < 1) {
                        alert("Please enter a valid quantity (at least 1).");
                        return;
                    }

                    if (hiddenActionNameInput) hiddenActionNameInput.value = 'buy_from_npc';
                    if (hiddenDetailsInput) {
                        hiddenDetailsInput.value = JSON.stringify({
                            npc_name: "Old Man Hemlock",
                            item_name: selectedHemlockHerbName,
                            quantity: quantity
                        });
                    }
                    if (actionForm) {
                        console.log("Submitting buy_from_npc action for Hemlock:", hiddenDetailsInput.value);
                        actionForm.submit();
                    }
                });
            }

            // Initial Display Logic:
            // currentTownSubLocations is passed from Jinja directly if character is loaded.
            // This variable is already defined at the top of this script block.
            // We need to use the sub-locations from allTownsData for the current town for consistency
            // as currentTownSubLocations might just be names, whereas allTownsData has descriptions.
            if (currentTownDisplay && currentTownDisplay.textContent && allTownsData && allTownsData[currentTownDisplay.textContent]) {
                 const currentTownData = allTownsData[currentTownDisplay.textContent];
                 if (currentTownData && currentTownData.sub_locations) {
                    displaySubLocations(currentTownData.sub_locations);
                 } else {
                    displaySubLocations([]); // Call with empty if no sub_locations defined
                 }
            } else {
                 // Fallback if current_town_name isn't set or no data for it
                 displaySubLocations([]); // Call with empty array
            }
        }

        // New UI interaction script
        const gameContainer = document.querySelector('.game-container');
        if (gameContainer) {
            const statsTab = document.getElementById('stats-tab');
            const statsContent = document.getElementById('stats-content');
            const inventoryTab = document.getElementById('inventory-tab');
            const inventoryContent = document.getElementById('inventory-content');
            // const actionsTab = document.getElementById('actions-tab'); // Old reference
            // const actionsContent = document.getElementById('actions-content'); // Old reference for direct toggle

            // New elements for Actions/Log tabs
            const actionsTabButton = document.getElementById('actions-tab-button');
            const logTabButton = document.getElementById('log-tab-button');
            const actionsPanelContent = document.getElementById('actions-panel-content');
            const logPanelContent = document.getElementById('log-panel-content');

            const infoTab = document.getElementById('info-tab');
            const infoContent = document.getElementById('info-content');

            const topRightMenuButton = document.getElementById('top-right-menu-button');
            const settingsPopup = document.getElementById('settings-popup');
            const settingsOption = document.getElementById('settings-option');
            const saveGameOption = document.getElementById('save-game-option');

            // REMOVED JavaScript hover listeners for statsTab, inventoryTab, and infoTab
            // CSS :hover will now handle their visibility and animation.

            // Old listener for #actions-tab (the container) is removed.
            // if (actionsTab && actionsContent) { ... }

            // New listeners for Actions/Log tab buttons
            if (actionsTabButton && actionsPanelContent && logTabButton && logPanelContent) {
                actionsTabButton.addEventListener('click', () => {
                    actionsPanelContent.classList.add('panel-visible');
                    logPanelContent.classList.remove('panel-visible');
                    actionsTabButton.classList.add('active-tab-button');
                    logTabButton.classList.remove('active-tab-button');
                });

                logTabButton.addEventListener('click', () => {
                    logPanelContent.classList.add('panel-visible');
                    actionsPanelContent.classList.remove('panel-visible');
                    logTabButton.classList.add('active-tab-button');
                    actionsTabButton.classList.remove('active-tab-button');
                });

                // Initial state: Make Actions tab active by default
                actionsTabButton.classList.add('active-tab-button');
                actionsPanelContent.classList.add('panel-visible');
                // Ensure log tab is not active/visible initially
                logTabButton.classList.remove('active-tab-button');
                logPanelContent.classList.remove('panel-visible');
            }


            if (topRightMenuButton && settingsPopup) {
                topRightMenuButton.addEventListener('click', () => {
                    settingsPopup.style.display = settingsPopup.style.display === 'none' || settingsPopup.style.display === '' ? 'block' : 'none';
                });
            }

            if (settingsOption) {
                settingsOption.addEventListener('click', () => {
                    console.log("Settings clicked");
                    settingsPopup.style.display = 'none'; // Hide popup after click
                });
            }

            if (saveGameOption) {
                saveGameOption.addEventListener('click', () => {
                    console.log("Save Game clicked");
                    settingsPopup.style.display = 'none'; // Hide popup after click
                });
            }

            // Optional: Close popup if clicked outside
            document.addEventListener('click', function(event) {
                if (settingsPopup && topRightMenuButton) {
                    const isClickInsideMenuButton = topRightMenuButton.contains(event.target);
                    const isClickInsidePopup = settingsPopup.contains(event.target);
                    if (!isClickInsideMenuButton && !isClickInsidePopup && settingsPopup.style.display === 'block') {
                        settingsPopup.style.display = 'none';
                    }
                }
            });

            // Click-outside-to-close for Actions/Log tabs
            const actionsTabContainer = document.getElementById('actions-tab');
            const actionsPanel = document.getElementById('actions-panel-content');
            const logPanel = document.getElementById('log-panel-content');
            const actionsButton = document.getElementById('actions-tab-button');
            const logButton = document.getElementById('log-tab-button');

            document.addEventListener('click', function(event) {
                const isActionsPanelVisible = actionsPanel && actionsPanel.classList.contains('panel-visible');
                const isLogPanelVisible = logPanel && logPanel.classList.contains('panel-visible');

                // Check if either panel is visible AND the click is outside the actionsTabContainer
                if ((isActionsPanelVisible || isLogPanelVisible) && actionsTabContainer && !actionsTabContainer.contains(event.target)) {
                    // Close both panels and deactivate both buttons
                    if (actionsPanel) actionsPanel.classList.remove('panel-visible');
                    if (logPanel) logPanel.classList.remove('panel-visible');
                    if (actionsButton) actionsButton.classList.remove('active-tab-button');
                    if (logButton) logButton.classList.remove('active-tab-button');
                }
            });
        }

        // Action Result Popup Handling
        const popupActionResult = {{ popup_action_result | tojson | safe }};
        const actionResultPopup = document.getElementById('action-result-popup');
        const actionResultMessage = document.getElementById('action-result-message');
        const closePopupButton = document.getElementById('close-popup-button');

        if (popupActionResult && popupActionResult.trim() !== "") {
            if (actionResultMessage) {
                // Replace newline characters with <br> tags for HTML display
                actionResultMessage.innerHTML = popupActionResult.replace(/\n/g, '<br>');
            }
            if (actionResultPopup) {
                actionResultPopup.style.display = 'block';
            }
        }

        if (closePopupButton && actionResultPopup) {
            closePopupButton.addEventListener('click', function() {
                actionResultPopup.style.display = 'none';
            });
        }
    });
    </script>
    {% endif %}

    <div id="action-result-popup" style="display: none;">
        <div id="action-result-message"></div>
        <button id="close-popup-button">Close</button>
    </div>

    <div id="subLocationActionsModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Actions</h3>
            <div id="modal-actions-list">
                <!-- Action buttons will be dynamically inserted here -->
            </div>
        </div>
    </div>
</body>
</html>
