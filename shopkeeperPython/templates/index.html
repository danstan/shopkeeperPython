<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopkeeper Adventure UI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden-details {
            display: none;
            margin-top: 10px;
        }
        .details-section label {
            display: block;
            margin-top: 5px;
        }
        .details-section input {
            width: calc(100% - 10px);
            padding: 5px;
            margin-top: 2px;
        }
        /* Styles for character creation */
        .character-creation-container {
            width: 50%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .character-creation-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .character-creation-container div {
            margin-bottom: 10px;
        }
        .character-creation-container label {
            display: inline-block;
            width: 150px;
        }
        .character-creation-container input[type="text"],
        .character-creation-container input[type="number"] { /* Added number for consistency if used later */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 170px); /* Adjust based on label width and padding */
        }
        .character-creation-container button, .login-container button, .google-login-button {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            text-decoration: none;
            display: inline-block;
            line-height: normal;
        }
        .login-container button {
            background-color: #007bff;
        }
        .character-creation-container button {
             background-color: #007bff;
        }
        /* Individual hover effects */
        .login-container button:hover {
            background-color: #0056b3;
        }
        .character-creation-container button:hover {
            background-color: #0056b3;
        }
        .google-login-button {
            background-color: #4285F4;
            margin-left: 0;
        }
        .google-login-button:hover {
            background-color: #357ae8;
        }
        .google-login-button img {
            width: 18px;
            height: 18px;
            vertical-align: middle;
            margin-right: 10px;
        }
        .character-creation-container button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* Styles for login container */
        .login-container {
            width: 300px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center;
        }
        .login-container h2 {
            margin-bottom: 20px;
        }
        .login-container input[type="text"],
        .login-container input[type="password"] {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .login-container p {
            margin-top: 15px;
        }

        /* Styles for character selection */
        .character-selection-container {
            width: 50%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center; /* Center h2 and p */
        }
        .character-selection-container h2 {
            margin-bottom: 20px;
        }
        .character-selection-container ul {
            list-style-type: none;
            padding: 0;
        }
        .character-selection-container li {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .character-selection-container li a {
            text-decoration: none;
            padding: 8px 15px;
            background-color: #28a745; /* Green for select */
            color: white;
            border-radius: 4px;
        }
        .character-selection-container li a:hover {
            background-color: #218838;
        }
        .character-selection-container .create-new-link {
            display: inline-block; /* To allow margin auto if needed, or just text-align center on parent */
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #007bff; /* Blue for create new */
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .character-selection-container .create-new-link:hover {
            background-color: #0056b3;
        }

        /* Styles for graveyard container */
        .graveyard-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }
        .graveyard-container h3 {
            margin-bottom: 15px;
            color: #555;
        }
        .graveyard-container ul {
            list-style-type: none;
            padding: 0;
        }
        .graveyard-container li {
            background-color: #e9ecef; /* Light grey background for dead chars */
            color: #495057; /* Darker text for contrast */
            padding: 8px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        .character-creation-container #stats_container div {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
        }
        .character-creation-container #stats_container span {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    {% if not user_logged_in %}
    <div class="login-container">
        <h2>Login</h2>
        <form action="{{ url_for('login_route') }}" method="post">
            <div>
                <input type="text" name="username" placeholder="Username" required>
            </div>
            <div>
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="{{ url_for('register_page') }}">Register here</a></p>
        {# Display ALL flash messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if google_auth_is_configured %}
        <div style="margin-top: 20px; text-align: center;">
            <p>OR</p>
            <a href="{{ url_for('google_initiate_login_route') }}" class="google-login-button">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
                Login with Google
            </a>
        </div>
        {% endif %}
    </div>

    {% elif show_character_selection %}
    <div class="character-selection-container">
        <h2>Select Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %} {# Show flashes here too #}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <ul>
            {% for char_info in characters_for_selection %}
            <li>
                <span>{{ char_info.name }} (Level {{ char_info.level }})</span>
                {% if char_info.is_dead %}
                    <span style="color: red; font-weight: bold;">DECEASED</span>
                {% else %}
                    <a href="{{ url_for('select_character_route', slot_index=char_info.slot_index) }}">Select</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {# The logic for showing "Create New Character" link:
           A user can always attempt to go to the creation screen if they have less than MAX_CHARS_PER_USER *total* slots filled.
           The app.py's /create_character route will enforce the final check on whether a new character can actually be stored.
           The display_game_output with action='create_new_char' also checks slot availability before showing the form.
        #}
        {% if characters_for_selection | length < MAX_CHARS_PER_USER %}
            <p><a href="{{ url_for('display_game_output', action='create_new_char') }}" class="create-new-link">Create New Character Slot</a></p>
        {% elif characters_for_selection | length >= MAX_CHARS_PER_USER %}
            <p>All character slots ({{ MAX_CHARS_PER_USER }}) are currently filled. A dead character occupies a slot.</p>
            {# Optionally, if we wanted to allow replacing a dead character (more complex):
               {% set living_chars = characters_for_selection | selectattr('is_dead', 'false') | list %}
               {% if living_chars | length < MAX_CHARS_PER_USER and (characters_for_selection | length == MAX_CHARS_PER_USER) %}
                 <p><a href="{{ url_for('display_game_output', action='create_new_char_replace_dead_prompt_logic_needed_in_app_py') }}" class="create-new-link">Create New Character (Replace Dead)</a></p>
               {% endif %}
            #}
        {% endif %}

        {% if dead_characters_info %}
        <div class="graveyard-container">
            <h3>Graveyard</h3>
            <ul>
                {% for dead_char in dead_characters_info %}
                <li>
                    {{ dead_char.name }} (Level {{ dead_char.level }}) - Resting in peace.
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

         <p style="margin-top: 20px;"><a href="{{ url_for('logout_route') }}">Logout</a></p>
    </div>

    {% elif show_character_creation_form %}
    <div class="character-creation-container">
        <h2>Create Your Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %} {# And here #}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form id="characterCreationForm" action="{{ url_for('create_character_route') }}" method="post">
            <div>
                <label for="character_name">Character Name:</label>
                <input type="text" id="character_name" name="character_name" required>
            </div>

            <h3>Character Stats:</h3>
            <p>Roll for your initial stats. You can reroll <em>one</em> stat <em>once</em>.</p>
            <div id="stats_container">
                <div>
                    <span>STR: <span id="stat_str_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="STR">Reroll STR</button>
                </div>
                <div>
                    <span>DEX: <span id="stat_dex_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="DEX">Reroll DEX</button>
                </div>
                <div>
                    <span>CON: <span id="stat_con_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="CON">Reroll CON</button>
                </div>
                <div>
                    <span>INT: <span id="stat_int_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="INT">Reroll INT</button>
                </div>
                <div>
                    <span>WIS: <span id="stat_wis_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="WIS">Reroll WIS</button>
                </div>
                <div>
                    <span>CHA: <span id="stat_cha_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="CHA">Reroll CHA</button>
                </div>
            </div>
            <input type="hidden" id="rerolled_stat_name" name="rerolled_stat_name" value="">
            <input type="hidden" id="rerolled_stat_value" name="rerolled_stat_value" value="">


            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" id="createCharacterButton">Create Character</button>
            </div>
        </form>
    </div>
    <script>
    // Character Creation Script (relevant only if this block is rendered)
    // This script should ideally be loaded conditionally or be specific to this section
    // For simplicity, keeping it here, but note it might run even if form not visible without further checks
    if (document.getElementById('characterCreationForm')) {
        let rerollUsed = false;
        const rerollButtons = document.querySelectorAll('.reroll-stat-button');
        const rerolledStatNameInput = document.getElementById('rerolled_stat_name');
        const rerolledStatValueInput = document.getElementById('rerolled_stat_value');
        // const createCharacterButton = document.getElementById('createCharacterButton'); // Already declared by form

        function rollStat() {
            return Math.floor(Math.random() * 6) + 1 +
                   Math.floor(Math.random() * 6) + 1 +
                   Math.floor(Math.random() * 6) + 1;
        }

        const stats = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
        let currentStats = {};

        stats.forEach(stat => {
            const rolledValue = rollStat();
            currentStats[stat] = rolledValue;
            const statValueElement = document.getElementById(`stat_${stat.toLowerCase()}_value`);
            if (statValueElement) {
                statValueElement.textContent = rolledValue;
            }
        });

        rerollButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (!rerollUsed) {
                    const statName = this.dataset.stat;
                    const newValue = rollStat();
                    const statValueElement = document.getElementById(`stat_${statName.toLowerCase()}_value`);
                    if (statValueElement) {
                        statValueElement.textContent = newValue;
                    }
                    currentStats[statName] = newValue;
                    if(rerolledStatNameInput) rerolledStatNameInput.value = statName;
                    if(rerolledStatValueInput) rerolledStatValueInput.value = newValue;
                    rerollUsed = true;
                    rerollButtons.forEach(btn => btn.disabled = true);
                    this.disabled = true;
                }
            });
        });

        const characterCreationForm = document.getElementById('characterCreationForm');
        characterCreationForm.addEventListener('submit', function() {
            for (const stat in currentStats) {
                let input = document.createElement('input');
                input.type = 'hidden';
                input.name = `stat_${stat.toLowerCase()}`;
                input.value = currentStats[stat];
                this.appendChild(input);
            }
        });
    }
    </script>

    {% else %}
    {# Main Game Interface #}
    <h1>Shopkeeper Adventure</h1>

    <div class="container">
        <div class="status-container">
            <div class="status-box">
                <h2>Player Status</h2>
                <p><strong>Name:</strong> {{ player_name }}</p>
                <p><strong>HP:</strong> {{ player_hp }} / {{ player_max_hp }}</p>
                <p><strong>Gold:</strong> {{ player_gold }} G</p>
                <p><strong>Stats:</strong></p>
                <ul>
                    {% for stat, value in player_stats.items() %}
                    <li><strong>{{ stat }}:</strong> {{ value }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="status-box">
                <h2>Game Info</h2>
                <p><strong>Current Time:</strong> {{ current_time }}</p>
                <p><strong>Current Town:</strong> {{ current_town_name }}</p>
            </div>
        </div>

        <div class="inventory-container">
            <div class="inventory-box">
                <h2>Shop Inventory</h2>
                {% if shop_inventory and shop_inventory[0] != "Empty" %}
                <ul>
                    {% for item_display_name in shop_inventory %}
                    <li>{{ item_display_name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Empty</p>
                {% endif %}
            </div>

            <div class="inventory-box">
                <h2>Player Inventory</h2>
                {% if player_inventory and player_inventory[0] != "Empty" %}
                <ul>
                    {% for item_name in player_inventory %}
                    <li>{{ item_name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Empty</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="log-action-container">
        <div class="log-box">
            <h2>Game Log</h2>
            <div id="game-output" style="white-space: pre-wrap; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                {{ game_output | safe }}
            </div>
        </div>

        <div class="action-box"> <!-- This class might be reused or restyled -->
            <h2>Game Actions</h2> <!-- Changed title -->

            <form id="actionForm" action="{{ url_for('perform_action') }}" method="post">
                <input type="hidden" id="action_name_hidden" name="action_name" value="">
                <input type="hidden" id="action_details" name="action_details" value="{}">
                <!-- Submit button might be dynamically added or made visible by JS,
                     or we can have a generic "Do Selected Action" button if an action is chosen.
                     For now, let action buttons themselves trigger form submission. -->
            </form>

            <div id="world-map-container" class="action-box-section"> <!-- New class for styling -->
                <h2>World Map</h2>
                <div id="map-destinations">
                    {% if available_towns %}
                        <p>Choose a destination to travel to:</p>
                        <ul>
                            {% for town_name_key in available_towns %}
                            <li><button class="map-destination-button" data-town-name="{{ town_name_key }}">{{ town_name_key }}</button></li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No destinations available.</p>
                    {% endif %}
                </div>
            </div>

            <div id="current-location-container" class="action-box-section">
                <h2>Current Location: <span id="current-town-display">{{ current_town_name }}</span></h2>
                <div id="sub-locations-list">
                    <!-- Sub-locations of the current town will be populated here by JavaScript -->
                </div>
                <div id="current-actions-list">
                    <!-- Actions for the selected sub-location will be populated here by JavaScript -->
                </div>
            </div>

            <!-- Container for Action Detail Forms -->
            <div id="action-details-container" class="action-box-section" style="flex-basis: 100%; display: none;"> <!-- Initially hidden, spans full width if flex items wrap -->
                <h3>Action Details</h3>

                <div id="div_craft_details" class="hidden-details details-section">
                    <h4>Craft Item</h4>
                    <label for="craft_item_name">Item Name to Craft:</label>
                    <input type="text" id="craft_item_name" name="craft_item_name_detail_input" placeholder="e.g., Minor Healing Potion">
                    <button type="button" class="submit-details-button" data-action="craft">Craft It!</button>
                </div>

                <div id="div_buy_details" class="hidden-details details-section">
                    <h4>Buy from Your Shop</h4>
                    <label for="buy_item_name">Item Name to Buy:</label>
                    <input type="text" id="buy_item_name" name="buy_item_name_detail_input" placeholder="e.g., Simple Dagger">
                    <label for="buy_quantity">Quantity:</label>
                    <input type="number" id="buy_quantity" name="buy_quantity_detail_input" value="1" min="1">
                    <button type="button" class="submit-details-button" data-action="buy_from_own_shop">Buy Item(s)</button>
                </div>

                <div id="div_sell_details" class="hidden-details details-section">
                    <h4>Sell to Your Shop</h4>
                    <label for="sell_item_name">Item Name to Sell:</label>
                    <input type="text" id="sell_item_name" name="sell_item_name_detail_input" placeholder="e.g., Stale Ale">
                    <button type="button" class="submit-details-button" data-action="sell_to_own_shop">Sell Item</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Main game interface script (relevant only if this block is rendered)
    // Ensure this script is placed after the HTML elements it interacts with, or wrapped in DOMContentLoaded.
    // For simplicity with Jinja, variables are passed here.
    var currentTownSubLocations = {{ current_town_sub_locations_json | default('[]') | safe }}; // May not be strictly needed if allTownsData is comprehensive
    var allTownsData = {{ all_towns_data_json | default('{}') | safe }};

    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('actionForm')) {
            const actionForm = document.getElementById('actionForm');
            const hiddenActionNameInput = document.getElementById('action_name_hidden');
            const hiddenDetailsInput = document.getElementById('action_details');

            const mapDestinationsDiv = document.getElementById('map-destinations');
            const subLocationsListDiv = document.getElementById('sub-locations-list');
            const currentActionsListDiv = document.getElementById('current-actions-list');
            const currentTownDisplay = document.getElementById('current-town-display');

            // Action Detail Divs and Inputs
            const actionDetailsContainer = document.getElementById('action-details-container');
            const craftDetailsDiv = document.getElementById('div_craft_details');
            const craftItemNameInput = document.getElementById('craft_item_name');
            const buyDetailsDiv = document.getElementById('div_buy_details');
            const buyItemNameInput = document.getElementById('buy_item_name');
            const buyQuantityInput = document.getElementById('buy_quantity');
            const sellDetailsDiv = document.getElementById('div_sell_details');
            const sellItemNameInput = document.getElementById('sell_item_name');

            const allDetailDivs = [craftDetailsDiv, buyDetailsDiv, sellDetailsDiv];
            let currentActionRequiringDetails = null; // Stores the action name when a detail form is shown

            function hideAllDetailForms() {
                if (actionDetailsContainer) actionDetailsContainer.style.display = 'none';
                allDetailDivs.forEach(div => { if (div) div.style.display = 'none'; });
            }

            function displaySubLocations(subLocations) {
                if (!subLocationsListDiv) return;
                subLocationsListDiv.innerHTML = '';
                if (currentActionsListDiv) currentActionsListDiv.innerHTML = '';
                hideAllDetailForms(); // Also hide detail forms when sub-locations are re-rendered

                if (subLocations && subLocations.length > 0) {
                    const ul = document.createElement('ul');
                    subLocations.forEach(subLoc => {
                        const li = document.createElement('li');
                        const button = document.createElement('button');
                        button.className = 'sub-location-button';
                        button.dataset.sublocName = subLoc.name;
                        button.textContent = subLoc.name;
                        li.appendChild(button);
                        if (subLoc.description) {
                            li.append(` - ${subLoc.description}`);
                        }
                        ul.appendChild(li);
                    });
                    subLocationsListDiv.appendChild(ul);
                } else {
                    subLocationsListDiv.innerHTML = '<p>No sub-locations here.</p>';
                }
            }

            // Function to display actions for a selected sub-location
            function displayActions(subLocName) {
                if (!currentActionsListDiv) return;
                currentActionsListDiv.innerHTML = ''; // Clear previous

                const currentTownName = currentTownDisplay ? currentTownDisplay.textContent : null;
                if (!currentTownName || !allTownsData || !allTownsData[currentTownName] || !allTownsData[currentTownName].sub_locations) {
                    console.error("Could not find current town data or sub-locations for action display.");
                    return;
                }
                const subLocationsData = allTownsData[currentTownName].sub_locations;


                const selectedSubLocation = subLocationsData.find(sl => sl.name === subLocName);

                if (selectedSubLocation && selectedSubLocation.actions && selectedSubLocation.actions.length > 0) {
                    const ul = document.createElement('ul');
                    selectedSubLocation.actions.forEach(actionStr => {
                        const li = document.createElement('li');
                        const button = document.createElement('button');
                        button.className = 'action-button';
                        button.dataset.actionName = actionStr;
                        button.textContent = actionStr.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Prettify
                        li.appendChild(button);
                        ul.appendChild(li);
                    });
                    currentActionsListDiv.appendChild(ul);
                } else {
                    currentActionsListDiv.innerHTML = '<p>No actions available here.</p>';
                }
            }

            // Event Listener for Map Destination Buttons
            if (mapDestinationsDiv) {
                mapDestinationsDiv.addEventListener('click', function(event) {
                    if (event.target.classList.contains('map-destination-button')) {
                        const townName = event.target.dataset.townName;
                        if (hiddenActionNameInput) hiddenActionNameInput.value = 'travel_to_town';
                        if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify({ town_name: townName });
                        if (actionForm) actionForm.submit();
                    }
                });
            }

            // Event Listener for Sub-location Buttons
            if (subLocationsListDiv) {
                subLocationsListDiv.addEventListener('click', function(event) {
                    if (event.target.classList.contains('sub-location-button')) {
                        const subLocName = event.target.dataset.sublocName;
                        displayActions(subLocName);
                    }
                });
            }

            // Event Listener for Action Buttons (from current-actions-list)
            if (currentActionsListDiv) {
                currentActionsListDiv.addEventListener('click', function(event) {
                    if (event.target.classList.contains('action-button')) {
                        const actionName = event.target.dataset.actionName;
                        hideAllDetailForms(); // Hide any open detail forms first
                        currentActionRequiringDetails = null; // Reset

                        if (hiddenActionNameInput) hiddenActionNameInput.value = actionName; // Set action name for the form

                        switch (actionName) {
                            case 'craft':
                                if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                                if (craftDetailsDiv) craftDetailsDiv.style.display = 'block';
                                currentActionRequiringDetails = actionName;
                                // Do NOT submit form yet
                                break;
                            case 'buy_from_own_shop':
                                if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                                if (buyDetailsDiv) buyDetailsDiv.style.display = 'block';
                                currentActionRequiringDetails = actionName;
                                // Do NOT submit form yet
                                break;
                            case 'sell_to_own_shop':
                                if (actionDetailsContainer) actionDetailsContainer.style.display = 'block';
                                if (sellDetailsDiv) sellDetailsDiv.style.display = 'block';
                                currentActionRequiringDetails = actionName;
                                // Do NOT submit form yet
                                break;
                            default:
                                // For actions not needing details
                                if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify({});
                                if (actionForm) actionForm.submit();
                                break;
                        }
                    }
                });
            }

            function compileAndSetActionDetails() {
                let details = {};
                if (!currentActionRequiringDetails) return; // Should not happen if a detail submit button was clicked

                switch (currentActionRequiringDetails) {
                    case 'craft':
                        if (craftItemNameInput && craftItemNameInput.value) {
                            details.item_name = craftItemNameInput.value;
                        }
                        break;
                    case 'buy_from_own_shop':
                        if (buyItemNameInput && buyItemNameInput.value) {
                            details.item_name = buyItemNameInput.value;
                        }
                        if (buyQuantityInput && buyQuantityInput.value) {
                            details.quantity = parseInt(buyQuantityInput.value, 10);
                        }
                        break;
                    case 'sell_to_own_shop':
                        if (sellItemNameInput && sellItemNameInput.value) {
                            details.item_name = sellItemNameInput.value;
                        }
                        break;
                }
                if (hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify(details);
            }

            // Event Listener for "Submit Details" buttons within each detail form
            if (actionDetailsContainer) {
                actionDetailsContainer.addEventListener('click', function(event) {
                    if (event.target.classList.contains('submit-details-button')) {
                        if (!currentActionRequiringDetails) {
                            console.error("Submit details button clicked but no currentActionRequiringDetails is set.");
                            return;
                        }
                        // The 'data-action' on the button should match currentActionRequiringDetails for sanity,
                        // but currentActionRequiringDetails is the primary driver here.
                        compileAndSetActionDetails(); // Compile details based on the visible form (tracked by currentActionRequiringDetails)
                        // action_name_hidden should already be set by the initial action button click.
                        if (actionForm) actionForm.submit();
                    }
                });
            }

            // Initial Display Logic:
            // currentTownSubLocations is passed from Jinja directly if character is loaded.
            // This variable is already defined at the top of this script block.
            // We need to use the sub-locations from allTownsData for the current town for consistency
            // as currentTownSubLocations might just be names, whereas allTownsData has descriptions.
            if (currentTownDisplay && currentTownDisplay.textContent && allTownsData && allTownsData[currentTownDisplay.textContent]) {
                 const currentTownData = allTownsData[currentTownDisplay.textContent];
                 if (currentTownData && currentTownData.sub_locations) {
                    displaySubLocations(currentTownData.sub_locations);
                 } else {
                    displaySubLocations([]); // Call with empty if no sub_locations defined
                 }
            } else {
                 // Fallback if current_town_name isn't set or no data for it
                 displaySubLocations([]); // Call with empty array
            }
        }
    });
    </script>
    {% endif %}
</body>
</html>
