<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopkeeper Adventure UI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden-details {
            display: none;
            margin-top: 10px;
        }
        .details-section label {
            display: block;
            margin-top: 5px;
        }
        .details-section input {
            width: calc(100% - 10px);
            padding: 5px;
            margin-top: 2px;
        }
        /* Styles for character creation */
        .character-creation-container {
            width: 50%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .character-creation-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .character-creation-container div {
            margin-bottom: 10px;
        }
        .character-creation-container label {
            display: inline-block;
            width: 150px;
        }
        .character-creation-container input[type="text"],
        .character-creation-container input[type="number"] { /* Added number for consistency if used later */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 170px); /* Adjust based on label width and padding */
        }
        .character-creation-container button, .login-container button { /* Apply to login button too */
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .character-creation-container button:hover, .login-container button:hover { /* Apply to login button too */
            background-color: #0056b3;
        }
        .character-creation-container button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* Styles for login container */
        .login-container {
            width: 300px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center;
        }
        .login-container h2 {
            margin-bottom: 20px;
        }
        .login-container input[type="text"],
        .login-container input[type="password"] {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .login-container p {
            margin-top: 15px;
        }

        /* Styles for character selection */
        .character-selection-container {
            width: 50%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center; /* Center h2 and p */
        }
        .character-selection-container h2 {
            margin-bottom: 20px;
        }
        .character-selection-container ul {
            list-style-type: none;
            padding: 0;
        }
        .character-selection-container li {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .character-selection-container li a {
            text-decoration: none;
            padding: 8px 15px;
            background-color: #28a745; /* Green for select */
            color: white;
            border-radius: 4px;
        }
        .character-selection-container li a:hover {
            background-color: #218838;
        }
        .character-selection-container .create-new-link {
            display: inline-block; /* To allow margin auto if needed, or just text-align center on parent */
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #007bff; /* Blue for create new */
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .character-selection-container .create-new-link:hover {
            background-color: #0056b3;
        }


        .character-creation-container #stats_container div {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
        }
        .character-creation-container #stats_container span {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    {% if not user_logged_in %}
    <div class="login-container">
        <h2>Login</h2>
        <form action="{{ url_for('login_route') }}" method="post">
            <div>
                <input type="text" name="username" placeholder="Username" required>
            </div>
            <div>
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="{{ url_for('register_page') }}">Register here</a></p>
        {# Display ALL flash messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    {% elif show_character_selection %}
    <div class="character-selection-container">
        <h2>Select Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %} {# Show flashes here too #}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <ul>
            {% for char_info in characters_for_selection %}
            <li>
                <span>{{ char_info.name }} (Level {{ char_info.level }})</span>
                {% if char_info.is_dead %}
                    <span style="color: red; font-weight: bold;">DECEASED</span>
                {% else %}
                    <a href="{{ url_for('select_character_route', slot_index=char_info.slot_index) }}">Select</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {# The logic for showing "Create New Character" link:
           A user can always attempt to go to the creation screen if they have less than MAX_CHARS_PER_USER *total* slots filled.
           The app.py's /create_character route will enforce the final check on whether a new character can actually be stored.
           The display_game_output with action='create_new_char' also checks slot availability before showing the form.
        #}
        {% if characters_for_selection | length < MAX_CHARS_PER_USER %}
            <p><a href="{{ url_for('display_game_output', action='create_new_char') }}" class="create-new-link">Create New Character Slot</a></p>
        {% elif characters_for_selection | length >= MAX_CHARS_PER_USER %}
            <p>All character slots ({{ MAX_CHARS_PER_USER }}) are currently filled. A dead character occupies a slot.</p>
            {# Optionally, if we wanted to allow replacing a dead character (more complex):
               {% set living_chars = characters_for_selection | selectattr('is_dead', 'false') | list %}
               {% if living_chars | length < MAX_CHARS_PER_USER and (characters_for_selection | length == MAX_CHARS_PER_USER) %}
                 <p><a href="{{ url_for('display_game_output', action='create_new_char_replace_dead_prompt_logic_needed_in_app_py') }}" class="create-new-link">Create New Character (Replace Dead)</a></p>
               {% endif %}
            #}
        {% endif %}
         <p><a href="{{ url_for('logout_route') }}">Logout</a></p>
    </div>

    {% elif show_character_creation_form %}
    <div class="character-creation-container">
        <h2>Create Your Character</h2>
        {% with messages = get_flashed_messages(with_categories=true) %} {# And here #}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form id="characterCreationForm" action="{{ url_for('create_character_route') }}" method="post">
            <div>
                <label for="character_name">Character Name:</label>
                <input type="text" id="character_name" name="character_name" required>
            </div>

            <h3>Character Stats:</h3>
            <p>Roll for your initial stats. You can reroll <em>one</em> stat <em>once</em>.</p>
            <div id="stats_container">
                <div>
                    <span>STR: <span id="stat_str_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="STR">Reroll STR</button>
                </div>
                <div>
                    <span>DEX: <span id="stat_dex_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="DEX">Reroll DEX</button>
                </div>
                <div>
                    <span>CON: <span id="stat_con_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="CON">Reroll CON</button>
                </div>
                <div>
                    <span>INT: <span id="stat_int_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="INT">Reroll INT</button>
                </div>
                <div>
                    <span>WIS: <span id="stat_wis_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="WIS">Reroll WIS</button>
                </div>
                <div>
                    <span>CHA: <span id="stat_cha_value">--</span></span>
                    <button type="button" class="reroll-stat-button" data-stat="CHA">Reroll CHA</button>
                </div>
            </div>
            <input type="hidden" id="rerolled_stat_name" name="rerolled_stat_name" value="">
            <input type="hidden" id="rerolled_stat_value" name="rerolled_stat_value" value="">


            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" id="createCharacterButton">Create Character</button>
            </div>
        </form>
    </div>
    <script>
    // Character Creation Script (relevant only if this block is rendered)
    // This script should ideally be loaded conditionally or be specific to this section
    // For simplicity, keeping it here, but note it might run even if form not visible without further checks
    if (document.getElementById('characterCreationForm')) {
        let rerollUsed = false;
        const rerollButtons = document.querySelectorAll('.reroll-stat-button');
        const rerolledStatNameInput = document.getElementById('rerolled_stat_name');
        const rerolledStatValueInput = document.getElementById('rerolled_stat_value');
        // const createCharacterButton = document.getElementById('createCharacterButton'); // Already declared by form

        function rollStat() {
            return Math.floor(Math.random() * 6) + 1 +
                   Math.floor(Math.random() * 6) + 1 +
                   Math.floor(Math.random() * 6) + 1;
        }

        const stats = ["STR", "DEX", "CON", "INT", "WIS", "CHA"];
        let currentStats = {};

        stats.forEach(stat => {
            const rolledValue = rollStat();
            currentStats[stat] = rolledValue;
            const statValueElement = document.getElementById(`stat_${stat.toLowerCase()}_value`);
            if (statValueElement) {
                statValueElement.textContent = rolledValue;
            }
        });

        rerollButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (!rerollUsed) {
                    const statName = this.dataset.stat;
                    const newValue = rollStat();
                    const statValueElement = document.getElementById(`stat_${statName.toLowerCase()}_value`);
                    if (statValueElement) {
                        statValueElement.textContent = newValue;
                    }
                    currentStats[statName] = newValue;
                    if(rerolledStatNameInput) rerolledStatNameInput.value = statName;
                    if(rerolledStatValueInput) rerolledStatValueInput.value = newValue;
                    rerollUsed = true;
                    rerollButtons.forEach(btn => btn.disabled = true);
                    this.disabled = true;
                }
            });
        });

        const characterCreationForm = document.getElementById('characterCreationForm');
        characterCreationForm.addEventListener('submit', function() {
            for (const stat in currentStats) {
                let input = document.createElement('input');
                input.type = 'hidden';
                input.name = `stat_${stat.toLowerCase()}`;
                input.value = currentStats[stat];
                this.appendChild(input);
            }
        });
    }
    </script>

    {% else %}
    {# Main Game Interface #}
    <h1>Shopkeeper Adventure</h1>

    <div class="container">
        <div class="status-container">
            <div class="status-box">
                <h2>Player Status</h2>
                <p><strong>Name:</strong> {{ player_name }}</p>
                <p><strong>HP:</strong> {{ player_hp }} / {{ player_max_hp }}</p>
                <p><strong>Gold:</strong> {{ player_gold }} G</p>
                <p><strong>Stats:</strong></p>
                <ul>
                    {% for stat, value in player_stats.items() %}
                    <li><strong>{{ stat }}:</strong> {{ value }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="status-box">
                <h2>Game Info</h2>
                <p><strong>Current Time:</strong> {{ current_time }}</p>
                <p><strong>Current Town:</strong> {{ current_town_name }}</p>
            </div>
        </div>

        <div class="inventory-container">
            <div class="inventory-box">
                <h2>Shop Inventory</h2>
                {% if shop_inventory and shop_inventory[0] != "Empty" %}
                <ul>
                    {% for item_display_name in shop_inventory %}
                    <li>{{ item_display_name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Empty</p>
                {% endif %}
            </div>

            <div class="inventory-box">
                <h2>Player Inventory</h2>
                {% if player_inventory and player_inventory[0] != "Empty" %}
                <ul>
                    {% for item_name in player_inventory %}
                    <li>{{ item_name }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>Empty</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="log-action-container">
        <div class="log-box">
            <h2>Game Log</h2>
            <div id="game-output" style="white-space: pre-wrap; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                {{ game_output | safe }}
            </div>
        </div>

        <div class="action-box">
            <h2>Perform Action</h2>
            <form id="actionForm" action="{{ url_for('perform_action') }}" method="post">
                <div>
                    <label for="action_name_select">Action:</label>
                    <select id="action_name_select" name="action_name">
                        <option value="wait">Wait</option>
                        <option value="talk_to_self">Talk to Self</option>
                        <option value="talk_to_customer" selected>Talk to Customer</option>
                        <option value="check_shop_inventory">Check Shop Inventory</option>
                        <option value="check_player_inventory">Check Player Inventory</option>
                        <option value="craft">Craft Item</option>
                        <option value="buy_from_own_shop">Buy from Shop</option>
                        <option value="sell_to_own_shop">Sell to Shop</option>
                        <option value="sleep_one_hour">Sleep for 1 Hour</option>
                        <option value="sleep_eight_hours">Sleep for 8 Hours</option>
                        <option value="explore_town">Explore Town</option>
                        <option value="research_market">Research Market</option>
                        <option value="travel_to_town">Travel to Town</option>
                        <!-- Add other actions here -->
                    </select>
                </div>

                <input type="hidden" id="action_details" name="action_details" value="{}">

                <div id="div_craft_details" class="hidden-details details-section">
                    <label for="craft_item_name">Item Name to Craft:</label>
                    <input type="text" id="craft_item_name" name="craft_item_name" placeholder="e.g., Minor Healing Potion">
                </div>

                <div id="div_buy_details" class="hidden-details details-section">
                    <label for="buy_item_name">Item Name to Buy:</label>
                    <input type="text" id="buy_item_name" name="buy_item_name" placeholder="e.g., Simple Dagger">
                    <label for="buy_quantity">Quantity:</label>
                    <input type="number" id="buy_quantity" name="buy_quantity" value="1" min="1">
                </div>

                <div id="div_sell_details" class="hidden-details details-section">
                    <label for="sell_item_name">Item Name to Sell:</label>
                    <input type="text" id="sell_item_name" name="sell_item_name" placeholder="e.g., Stale Ale">
                </div>

                <div id="div_travel_details" class="hidden-details details-section">
                    <label for="travel_town_name">Destination Town Name:</label>
                    <input type="text" id="travel_town_name" name="travel_town_name" placeholder="e.g., Steel Flow City">
                </div>

                <input type="submit" value="Perform Action">
            </form>
            <p style="font-size: 0.9em; margin-top: 10px;">
                Instructions: Select an action. If the action requires details (like an item name), corresponding fields will appear.
            </p>
        </div>
    </div>

    <script>
    // Main game interface script (relevant only if this block is rendered)
    if (document.getElementById('actionForm')) {
        document.addEventListener('DOMContentLoaded', function() { // Ensure this runs after DOM is loaded
            const actionSelect = document.getElementById('action_name_select');
            const hiddenDetailsInput = document.getElementById('action_details');

            const craftDetailsDiv = document.getElementById('div_craft_details');
            const craftItemNameInput = document.getElementById('craft_item_name');

            const buyDetailsDiv = document.getElementById('div_buy_details');
            const buyItemNameInput = document.getElementById('buy_item_name');
            const buyQuantityInput = document.getElementById('buy_quantity');

            const sellDetailsDiv = document.getElementById('div_sell_details');
            const sellItemNameInput = document.getElementById('sell_item_name');

            const travelDetailsDiv = document.getElementById('div_travel_details');
            const travelTownNameInput = document.getElementById('travel_town_name');

            const allDetailDivs = [craftDetailsDiv, buyDetailsDiv, sellDetailsDiv, travelDetailsDiv];
            const allDetailInputs = [
                craftItemNameInput,
                buyItemNameInput, buyQuantityInput,
                sellItemNameInput,
                travelTownNameInput
            ];

            function hideAllDetailDivs() {
                allDetailDivs.forEach(div => { if(div) div.style.display = 'none'; });
            }

            function compileAndSetActionDetails() {
                const selectedAction = actionSelect.value;
                let details = {};

                switch (selectedAction) {
                    case 'craft':
                        if (craftItemNameInput && craftItemNameInput.value) {
                            details.item_name = craftItemNameInput.value;
                        }
                        break;
                    case 'buy_from_own_shop':
                        if (buyItemNameInput && buyItemNameInput.value) {
                            details.item_name = buyItemNameInput.value;
                        }
                        if (buyQuantityInput && buyQuantityInput.value) {
                            details.quantity = parseInt(buyQuantityInput.value, 10);
                        }
                        break;
                    case 'sell_to_own_shop':
                        if (sellItemNameInput && sellItemNameInput.value) {
                            details.item_name = sellItemNameInput.value;
                        }
                        break;
                    case 'travel_to_town':
                        if (travelTownNameInput && travelTownNameInput.value) {
                            details.town_name = travelTownNameInput.value;
                        }
                        break;
                }
                if(hiddenDetailsInput) hiddenDetailsInput.value = JSON.stringify(details);
            }

            if(actionSelect) {
                actionSelect.addEventListener('change', function() {
                    hideAllDetailDivs();
                    const selectedAction = this.value;

                    switch (selectedAction) {
                        case 'craft':
                            if(craftDetailsDiv) craftDetailsDiv.style.display = 'block';
                            break;
                        case 'buy_from_own_shop':
                            if(buyDetailsDiv) buyDetailsDiv.style.display = 'block';
                            break;
                        case 'sell_to_own_shop':
                            if(sellDetailsDiv) sellDetailsDiv.style.display = 'block';
                            break;
                        case 'travel_to_town':
                            if(travelDetailsDiv) travelDetailsDiv.style.display = 'block';
                            break;
                    }
                    compileAndSetActionDetails();
                });

                allDetailInputs.forEach(input => {
                    if (input) {
                        input.addEventListener('input', compileAndSetActionDetails);
                    }
                });
                actionSelect.dispatchEvent(new Event('change')); // Initial setup
            }
        });
    }
    </script>
    {% endif %}
</body>
</html>
